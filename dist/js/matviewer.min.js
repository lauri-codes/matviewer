var matviewer=function(e){var t={};function s(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,s),o.l=!0,o.exports}return s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)s.d(i,o,function(t){return e[t]}.bind(null,o));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){e.exports=s(1)},function(e,t,s){"use strict";s.r(t),s.d(t,"StructureViewer",(function(){return m})),s.d(t,"BrillouinZoneViewer",(function(){return E}));var i=new CustomEvent("change"),o=new CustomEvent("start"),n=new CustomEvent("end"),r=-1,a=0,l=1,h=2,c=3,d=4;class u{constructor(e,t){this._state=r,this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.enableRotate=!0,this.enableZoom=!0,this.enablePan=!0,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68],this.rotationCenter=new THREE.Vector3,this.target=new THREE.Vector3,this._prevState=r,this._eye=new THREE.Vector3,this._movePrev=new THREE.Vector2,this._moveCurr=new THREE.Vector2,this._lastAxis=new THREE.Vector3,this._lastAngle=0,this._lastPosition=new THREE.Vector3,this._zoomStart=new THREE.Vector2,this._zoomEnd=new THREE.Vector2,this._touchZoomDistanceStart=0,this._touchZoomDistanceEnd=0,this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this._zoomed=!1,this.rotationCenter0=this.rotationCenter.clone(),this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.zoom0=this.object.zoom,this.domElement.addEventListener("contextmenu",this.contextmenu.bind(this),!1),this.domElement.addEventListener("mousedown",this.mousedown.bind(this),!1),this.domElement.addEventListener("mousewheel",this.mousewheel,!1),this.domElement.addEventListener("MozMousePixelScroll",this.mousewheel.bind(this),!1),this.domElement.addEventListener("touchstart",this.touchstart.bind(this),!1),this.domElement.addEventListener("touchend",this.touchend.bind(this),!1),this.domElement.addEventListener("touchmove",this.touchmove.bind(this),!1),window.addEventListener("keydown",this.keydown.bind(this),!1),window.addEventListener("keyup",this.keyup.bind(this),!1),window.addEventListener("keydown",this.keydown.bind(this),!1),document.addEventListener("mousemove",this.mousemove.bind(this),!1),document.addEventListener("mouseup",this.mouseup.bind(this),!1),this.handleResize(),this.update()}handleResize(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}}handleEvent(e){"function"==typeof this[e.type]&&this[e.type](e)}getMouseOnScreen(e,t){var s=new THREE.Vector2;return s.set((e-this.screen.left)/this.screen.width,(t-this.screen.top)/this.screen.width),s}getMouseOnCircle(e,t){var s=new THREE.Vector2;return s.set((e-.5*this.screen.width-this.screen.left)/(.5*this.screen.width),(this.screen.height+2*(this.screen.top-t))/this.screen.width),s}rotateCamera(){var e,t=new THREE.Vector3,s=new THREE.Quaternion,i=new THREE.Vector3,o=new THREE.Vector3,n=new THREE.Vector3,r=new THREE.Vector3;if(r.set(this._moveCurr.x-this._movePrev.x,this._moveCurr.y-this._movePrev.y,0),e=r.length()){this._eye.copy(this.object.position).sub(this.rotationCenter),i.copy(this._eye).normalize(),o.copy(this.object.up).normalize(),n.crossVectors(o,i).normalize(),o.setLength(this._moveCurr.y-this._movePrev.y),n.setLength(this._moveCurr.x-this._movePrev.x),r.copy(o.add(n)),t.crossVectors(r,this._eye).normalize();var a=this.object.zoom;e*=this.rotateSpeed,e/=a,s.setFromAxisAngle(t,e),this._eye.applyQuaternion(s),this.object.up.applyQuaternion(s),this._lastAxis.copy(t),this._lastAngle=e}else!this.staticMoving&&this._lastAngle&&(this._lastAngle*=Math.sqrt(1-this.dynamicDampingFactor),this._eye.copy(this.object.position).sub(this.rotationCenter),s.setFromAxisAngle(this._lastAxis,this._lastAngle),this._eye.applyQuaternion(s),this.object.up.applyQuaternion(s));this._movePrev.copy(this._moveCurr)}zoomCamera(){var e;this._state===d?(e=this._touchZoomDistanceStart/this._touchZoomDistanceEnd,this._touchZoomDistanceStart=this._touchZoomDistanceEnd,this.object.zoom/=e,this.object.updateProjectionMatrix(),this._zoomed=!0):1!==(e=1+(this._zoomEnd.y-this._zoomStart.y)*this.zoomSpeed)&&e>0&&(this.object.zoom/=e,this.object.updateProjectionMatrix(),this._zoomed=!0,this.staticMoving?this._zoomStart.copy(this._zoomEnd):this._zoomStart.y+=(this._zoomEnd.y-this._zoomStart.y)*this.dynamicDampingFactor)}panCamera(){var e=new THREE.Vector2,t=new THREE.Vector3,s=new THREE.Vector3;if(e.copy(this._panEnd).sub(this._panStart),e.lengthSq()){var i=this.object.zoom;e.multiplyScalar(this.panSpeed/i),s.copy(this._eye).cross(this.object.up).setLength(e.x),s.add(t.copy(this.object.up).setLength(e.y)),this.object.position.add(s),this.rotationCenter.add(s),this.staticMoving?this._panStart.copy(this._panEnd):this._panStart.add(e.subVectors(this._panEnd,this._panStart).multiplyScalar(this.dynamicDampingFactor))}}checkDistances(){(this.enableZoom||this.enablePan)&&(this._eye.lengthSq()>this.maxDistance*this.maxDistance&&(this.object.position.addVectors(this.rotationCenter,this._eye.setLength(this.maxDistance)),this._zoomStart.copy(this._zoomEnd)),this._eye.lengthSq()<this.minDistance*this.minDistance&&(this.object.position.addVectors(this.rotationCenter,this._eye.setLength(this.minDistance)),this._zoomStart.copy(this._zoomEnd)))}update(){this._eye.subVectors(this.object.position,this.rotationCenter),this.enableRotate&&this.rotateCamera(),this.enableZoom&&this.zoomCamera(),this.enablePan&&this.panCamera(),this.object.position.addVectors(this.rotationCenter,this._eye),this.checkDistances(),this.object.lookAt(this.rotationCenter),(this._lastPosition.distanceToSquared(this.object.position)>1e-4||this._zoomed)&&(this.dispatchEvent(i),this._lastPosition.copy(this.object.position),this._zoomed=!1)}saveReset(){this.rotationCenter0.copy(this.rotationCenter),this.position0.copy(this.object.position),this.up0.copy(this.object.up),this.zoom0=this.object.zoom}reset(){this._state=r,this._prevState=r,this.rotationCenter.copy(this.rotationCenter0),this.object.position.copy(this.position0),this.object.up.copy(this.up0),this._eye.subVectors(this.object.position,this.rotationCenter),this.object.lookAt(this.rotationCenter),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(i),this._lastPosition.copy(this.object.position)}dispose(){this.domElement.removeEventListener("contextmenu",this.contextmenu.bind(this),!1),this.domElement.removeEventListener("mousedown",this.mousedown.bind(this),!1),this.domElement.removeEventListener("mousewheel",this.mousewheel.bind(this),!1),this.domElement.removeEventListener("MozMousePixelScroll",this.mousewheel.bind(this),!1),this.domElement.removeEventListener("touchstart",this.touchstart.bind(this),!1),this.domElement.removeEventListener("touchend",this.touchend.bind(this),!1),this.domElement.removeEventListener("touchmove",this.touchmove.bind(this),!1),document.removeEventListener("mousemove",this.mousemove.bind(this),!1),document.removeEventListener("mouseup",this.mouseup.bind(this),!1),window.removeEventListener("keydown",this.keydown.bind(this),!1),window.removeEventListener("keyup",this.keyup.bind(this),!1)}keydown(e){!1!==this.enabled&&(window.removeEventListener("keydown",this.keydown.bind(this)),this._prevState=this._state,this._state===r&&(e.keyCode===this.keys[a]&&this.enableRotate?this._state=a:e.keyCode===this.keys[l]&&this.enableZoom?this._state=l:e.keyCode===this.keys[h]&&this.enablePan&&(this._state=h)))}keyup(e){!1!==this.enabled&&(this._state=this._prevState)}mousedown(e){!1!==this.enabled&&(e.preventDefault(),e.stopPropagation(),this._state===r&&(this._state=e.button),this._state===a&&this.enableRotate?(this._moveCurr.copy(this.getMouseOnCircle(e.pageX,e.pageY)),this._movePrev.copy(this._moveCurr)):this._state===l&&this.enableZoom?(this._zoomStart.copy(this.getMouseOnScreen(e.pageX,e.pageY)),this._zoomEnd.copy(this._zoomStart)):this._state===h&&this.enablePan&&(this._panStart.copy(this.getMouseOnScreen(e.pageX,e.pageY)),this._panEnd.copy(this._panStart)),this.dispatchEvent(o))}mousemove(e){!1!==this.enabled&&(e.preventDefault(),e.stopPropagation(),this._state===a&&this.enableRotate?(this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this.getMouseOnCircle(e.pageX,e.pageY))):this._state===l&&this.enableZoom?this._zoomEnd.copy(this.getMouseOnScreen(e.pageX,e.pageY)):this._state===h&&this.enablePan&&this._panEnd.copy(this.getMouseOnScreen(e.pageX,e.pageY)),this.update())}mouseup(e){!1!==this.enabled&&(e.preventDefault(),e.stopPropagation(),this._state=r,document.removeEventListener("mousemove",this.mousemove.bind(this)),document.removeEventListener("mouseup",this.mouseup.bind(this)),this.dispatchEvent(n))}mousewheel(e){if(!1!==this.enabled){e.preventDefault(),e.stopPropagation();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),this._zoomStart.y+=.01*t,this.dispatchEvent(o),this.dispatchEvent(n),this.update()}}touchstart(e){if(!1!==this.enabled){switch(e.touches.length){case 1:this._state=c,this._moveCurr.copy(this.getMouseOnCircle(e.touches[0].pageX,e.touches[0].pageY)),this._movePrev.copy(this._moveCurr);break;default:this._state=d;var t=e.touches[0].pageX-e.touches[1].pageX,s=e.touches[0].pageY-e.touches[1].pageY;this._touchZoomDistanceEnd=this._touchZoomDistanceStart=Math.sqrt(t*t+s*s);var i=(e.touches[0].pageX+e.touches[1].pageX)/2,n=(e.touches[0].pageY+e.touches[1].pageY)/2;this._panStart.copy(this.getMouseOnScreen(i,n)),this._panEnd.copy(this._panStart)}this.dispatchEvent(o)}}touchmove(e){if(!1!==this.enabled){switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this.getMouseOnCircle(e.touches[0].pageX,e.touches[0].pageY));break;default:var t=e.touches[0].pageX-e.touches[1].pageX,s=e.touches[0].pageY-e.touches[1].pageY;this._touchZoomDistanceEnd=Math.sqrt(t*t+s*s);var i=(e.touches[0].pageX+e.touches[1].pageX)/2,o=(e.touches[0].pageY+e.touches[1].pageY)/2;this._panEnd.copy(this.getMouseOnScreen(i,o))}this.update()}}touchend(e){if(!1!==this.enabled){switch(e.touches.length){case 0:this._state=r;break;case 1:this._state=c,this._moveCurr.copy(this.getMouseOnCircle(e.touches[0].pageX,e.touches[0].pageY)),this._movePrev.copy(this._moveCurr)}this.dispatchEvent(n)}}contextmenu(e){e.preventDefault()}addEventListener(e,t){void 0===this._listeners&&(this._listeners={});var s=this._listeners;void 0===s[e]&&(s[e]=[]),-1===s[e].indexOf(t)&&s[e].push(t)}hasEventListener(e,t){if(void 0===this._listeners)return!1;var s=this._listeners;return void 0!==s[e]&&-1!==s[e].indexOf(t)}removeEventListener(e,t){if(void 0!==this._listeners){var s=this._listeners[e];if(void 0!==s){var i=s.indexOf(t);-1!==i&&s.splice(i,1)}}}dispatchEvent(e){if(void 0!==this._listeners){var t=this._listeners[e.type];if(void 0!==t)for(var s=t.slice(0),i=0,o=s.length;i<o;i++)s[i].call(this,e)}}}class p{constructor(e,t={}){this.hostElement=e,this.scenes=[],this.cameraWidth=10,this.options={},this.handleSettings(t),this.setupRootElement(),this.setupRenderer(),this.setupScenes(),this.setupStatic(),this.setupCamera(),this.setupControls(),this.setupHostElement(e),this.options.view.autoResize&&window.addEventListener("resize",this.onWindowResize.bind(this),!1)}handleSettings(e){let t={controls:{enableZoom:!0,enableRotate:!0,enablePan:!0,panSpeed:10,zoomSpeed:2.5,rotateSpeed:2.5,zoomLevel:1},view:{autoFit:!0,autoResize:!0,fitMargin:.5},style:{backgroundColor:[16777215,0],font:{family:"Arial"}}};this.fillOptions(e,t),this.options=t}fillOptions(e,t){!function e(t,s,i){for(var o in t)"object"==typeof t[o]&&null!==t[o]?(void 0===s[o]&&(s[o]={}),e(t[o],s[o])):s[o]=t[o]}(e,t)}load(e){this.clear(),this.setupScenes(),this.setupLights(),this.setupCamera(),this.setupControls();let t=this.setupVisualization(e);return this.options.view.autoFit&&this.fitToCanvas(),this.render(),t}loadJSON(e){var t=new XMLHttpRequest;t.onreadystatechange=()=>{this.load(JSON.parse(t.responseText))},t.open("GET",e,!0),t.send()}setupStatic(){}setupScenes(){this.scenes=[],this.scene=new THREE.Scene,this.scenes.push(this.scene)}clear(){this.clearScenes(),this.scenes=null,this.controls=null,this.camera=null,this.cornerPoints=null}clearScenes(){for(let e=0;e<this.scenes.length;++e){let t=this.scenes[e];for(t.traverse((function(e){let t=e.geometry,s=e.material,i=e.texture;t&&t.dispose(),s&&s.dispose(),i&&i.dispose()}));t.children.length;){let e=t.children[0];t.remove(e)}}}takeScreenShot(e){let t;try{let s="image/png",i="image/octet-stream";this.render(),t=this.renderer.domElement.toDataURL(s);let o=t.replace(s,i);e+=".png";let n=document.createElement("a");"string"==typeof n.download?(document.body.appendChild(n),n.download=e,n.href=o,n.click(),document.body.removeChild(n)):location.replace(uri)}catch(e){return void console.log(e)}}webglAvailable(){try{let e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}setupRenderer(){this.webglAvailable()?this.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}):console.log("WebGL is not supported on this browser, cannot display structure.");let e=this.options.style.backgroundColor;this.renderer.shadowMap.enabled=!1,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,this.renderer.setSize(this.rootElement.clientWidth,this.rootElement.clientHeight),this.renderer.setClearColor(e[0],e[1]),this.rootElement.appendChild(this.renderer.domElement),this.renderer.autoClear=!1}setupCamera(){let e=this.rootElement.clientWidth/this.rootElement.clientHeight,t=this.cameraWidth,s=t/e;this.camera=new THREE.OrthographicCamera(t/-2,t/2,s/2,s/-2,-100,1e3),this.camera.name="camera",this.camera.position.z=20}setupRootElement(){this.rootElement=document.createElement("div"),this.rootElement.style.width="100%",this.rootElement.style.height="100%",this.rootElement.style.position="relative"}setupHostElement(e){if(this.hostElement)for(;this.hostElement.firstChild;)this.hostElement.removeChild(this.hostElement.firstChild);e.appendChild(this.rootElement),this.resizeCanvasToHostElement()}changeHostElement(e){this.setupHostElement(e),this.options.view.autoFit&&this.fitToCanvas(),this.render()}saveReset(){this.controls.saveReset()}reset(){this.controls.reset()}setupControls(){let e=new u(this.camera,this.rootElement);e.rotateSpeed=this.options.controls.rotateSpeed,e.rotationCenter=new THREE.Vector3,e.zoomSpeed=this.options.controls.zoomSpeed,e.panSpeed=this.options.controls.panSpeed,e.enableZoom=this.options.controls.enableZoom,e.enablePan=this.options.controls.enablePan,e.enableRotate=this.options.controls.enableRotate,e.staticMoving=!0,e.dynamicDampingFactor=.25,e.keys=[65,83,68],e.addEventListener("change",this.render.bind(this)),this.controls=e}createCornerPoints(e,t){var s=new THREE.Geometry;s.vertices.push(e);let i=e.clone().add(t[0]).add(t[1]).add(t[2]);s.vertices.push(i);for(let o=t.length,n=0;n<o;++n){let o=e.clone().add(t[n].clone());s.vertices.push(o);let r=i.clone().sub(t[n].clone());s.vertices.push(r)}return s}fitToCanvas(){this.scenes.forEach(e=>e.updateMatrixWorld());let e=this.rootElement,t=e.clientWidth,s=e.clientHeight,i=[],o=new THREE.Vector3;for(let e=this.cornerPoints.geometry.vertices.length,t=0;t<e;++t){let e=this.cornerPoints.geometry.vertices[t].clone();this.cornerPoints.localToWorld(e),o.add(e)}for(let e=this.cornerPoints.geometry.vertices.length,n=0;n<e;++n){let e=this.cornerPoints.geometry.vertices[n].clone();this.cornerPoints.localToWorld(e);this.camera.zoom;this.camera.zoom=this.options.controls.zoomLevel,this.camera.updateProjectionMatrix();let r=o.sub(e);r.project(this.camera);let a=r.x<0,l=r.y<0;e.project(this.camera);let h=this.options.view.fitMargin,c=new THREE.Vector3(0,h,0),d=new THREE.Vector3(h,0,0);c.applyQuaternion(this.camera.quaternion),d.applyQuaternion(this.camera.quaternion),l?e.add(c):e.sub(c),a?e.add(d):e.sub(d),e.x=Math.round((e.x+1)*t/2),e.y=Math.round((1-e.y)*s/2),e.z=0,i.push(e)}let n=i[0].x,r=i[0].x,a=i[0].y,l=i[0].y;for(let e=i.length,t=0;t<e;++t){let e=i[t],s=e.x,o=e.y;s>r?r=s:s<n&&(n=s),o>l?l=o:o<a&&(a=o)}let h,c=t/(r-n),d=s/(l-a);c<=1&&d<=1||c>=1&&d>=1?h=Math.min(c,d):c<=1&&d>=1?h=c:d<=1&&c>=1&&(h=d),this.camera.zoom=h,this.camera.updateProjectionMatrix()}getZoom(){return this.camera.zoom}setZoom(e){this.camera.zoom=e,this.camera.updateProjectionMatrix()}resizeCanvasToHostElement(){let e=this.rootElement.clientWidth/this.rootElement.clientHeight,t=this.cameraWidth,s=t/e;this.camera.left=-t/2,this.camera.right=t/2,this.camera.top=s/2,this.camera.bottom=-s/2,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.rootElement.clientWidth,this.rootElement.clientHeight),this.controls.handleResize(),this.render()}onWindowResize(){this.resizeCanvasToHostElement(),this.options.view.autoFit&&this.fitToCanvas(),this.render()}render(){this.renderer.clear();for(let e=0;e<this.scenes.length;++e){let t=this.scenes[e];this.renderer.render(t,this.camera),e!==this.scenes.length-1&&this.renderer.clearDepth()}}createCylinder(e,t,s,i,o){var n=(new THREE.Vector3).subVectors(t,e);let r=n.length(),a=n.clone().divideScalar(r);var l=new THREE.ArrowHelper(a,e),h=new THREE.CylinderGeometry(s,s,r,i,0),c=new THREE.Mesh(h,o);return c.rotation.copy(l.rotation.clone()),c.position.copy((new THREE.Vector3).addVectors(e,n.multiplyScalar(.5))),c}rotateAroundWorldAxis(e,t,s){let i=new THREE.Matrix4;i.makeRotationAxis(t.normalize(),s),i.multiply(e.matrix),e.matrix=i,e.rotation.setFromRotationMatrix(e.matrix)}}class m extends p{constructor(){super(...arguments),this.axisLabels=[],this.wrapTolerance=.05,this.tagColorMap={adsorbates:"0xd70000",unknowns:"0xd75f00",interstitials:"0xaf8700",substitutions:"0x0087ff",outliers:"0x0087ff"},this.elementNames=["H","He","Li","Be","B","C","N","O","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Ge","As","Se","Br","Kr","Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I","Xe","Cs","Ba","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","At","Rn","Fr","Ra","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr","Rf","Ha","Sg","Ns","Hs","Mt","Ds","Rg","Cn","Nh","Fl","Mc","Lv","Ts","Og"],this.elementNumbers={H:1,He:2,Li:3,Be:4,B:5,C:6,N:7,O:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,S:16,Cl:17,Ar:18,K:19,Ca:20,Sc:21,Ti:22,V:23,Cr:24,Mn:25,Fe:26,Co:27,Ni:28,Cu:29,Zn:30,Ga:31,Ge:32,As:33,Se:34,Br:35,Kr:36,Rb:37,Sr:38,Y:39,Zr:40,Nb:41,Mo:42,Tc:43,Ru:44,Rh:45,Pd:46,Ag:47,Cd:48,In:49,Sn:50,Sb:51,Te:52,I:53,Xe:54,Cs:55,Ba:56,La:57,Ce:58,Pr:59,Nd:60,Pm:61,Sm:62,Eu:63,Gd:64,Tb:65,Dy:66,Ho:67,Er:68,Tm:69,Yb:70,Lu:71,Hf:72,Ta:73,W:74,Re:75,Os:76,Ir:77,Pt:78,Au:79,Hg:80,Tl:81,Pb:82,Bi:83,Po:84,At:85,Rn:86,Fr:87,Ra:88,Ac:89,Th:90,Pa:91,U:92,Np:93,Pu:94,Am:95,Cm:96,Bk:97,Cf:98,Es:99,Fm:100,Md:101,No:102,Lr:103},this.missing=.2,this.elementRadii=[this.missing,.31,.28,1.28,.96,.84,.76,.71,.66,.57,.58,1.66,1.41,1.21,1.11,1.07,1.05,1.02,1.06,2.03,1.76,1.7,1.6,1.53,1.39,1.39,1.32,1.26,1.24,1.32,1.22,1.22,1.2,1.19,1.2,1.2,1.16,2.2,1.95,1.9,1.75,1.64,1.54,1.47,1.46,1.42,1.39,1.45,1.44,1.42,1.39,1.39,1.38,1.39,1.4,2.44,2.15,2.07,2.04,2.03,2.01,1.99,1.98,1.98,1.96,1.94,1.92,1.92,1.89,1.9,1.87,1.87,1.75,1.7,1.62,1.51,1.44,1.41,1.36,1.36,1.32,1.45,1.46,1.48,1.4,1.5,1.5,2.6,2.21,2.15,2.06,2,1.96,1.9,1.87,1.8,1.69,this.missing,this.missing,this.missing,this.missing,this.missing,this.missing,this.missing],this.elementColors=[16711680,16777215,14286847,13402367,12779264,16758197,9474192,3166456,16715021,9494608,11789301,11230450,9109248,12560038,1578e4,16744448,16777008,2093087,8442339,9388244,4062976,15132390,12567239,10921643,9083335,10255047,14706227,15765664,5296208,13140019,8224944,12750735,6721423,12419299,16752896,10889513,6076625,7351984,65280,9764863,9756896,7586505,5551541,3907230,2396047,687500,27013,12632256,16767375,10909043,6717568,10380213,13924864,9699476,4366e3,5707663,51456,7394559,16777159,14286791,13107143,10747847,9437127,6422471,4587463,3211207,2097095,65436,58997,54354,48952,43812,5096191,5089023,2200790,2522539,2516630,1528967,13684960,16765219,12105936,10900557,5724513,10375093,11230208,7688005,4358806,4325478,32e3,7384058,47871,41471,36863,33023,27647,5528818,7888099,9064419,10565332,11739092,11739066,11734438,12389767,13041766,13369433,13697103,14221381,14680120,15073326,15400998]}setupScenes(){this.scenes=[],this.sceneStructure=new THREE.Scene,this.scenes.push(this.sceneStructure),this.sceneInfo=new THREE.Scene,this.scenes.push(this.sceneInfo)}handleSettings(e){let t={view:{fitMargin:.5},structure:{showParam:!0,createLegend:!0,showLegend:!0,showBonds:!0,allowRepeat:!0,showCopies:!1,showCell:!0,wrap:!0,radiusScale:1,bondScale:1,translation:[0,0,0],viewCenter:"COP",showShadows:!1}};this.fillOptions(e,t),super.handleSettings(t)}setupVisualization(e){e.primitiveCell;let t=e.cell,s=e.scaledPositions,i=e.positions,o=e.atomicNumbers,n=e.chemicalSymbols,r=e.pbc,a=e.bonds;if(this.tags=e.tags,!s&&!i)return console.log("No atom positions given to the structure viewer"),!1;if(!o&&!n)return console.log("No atomicNumbers or chemicalSymbols given to the structure viewer."),!1;if(o||(o=n.map(e=>this.elementNumbers[e])),a){if("off"!=a&&"auto"!=a&&!Array.isArray(a))return console.log("Invalid value for 'bonds'. Use either 'auto', 'off' or provide a list of index pairs. If not defined, 'auto' is assumed."),!1}else;if(i&&i.length!=o.length)return console.log("The number of positions does not match the number of labels."),!1;if(s&&s.length!=o.length)return console.log("The number of scaled positions does not match the number of labels."),!1;null!=r&&null!=r||(r=[!0,!0,!0]),this.root=new THREE.Object3D,this.atoms=new THREE.Object3D,this.bonds=new THREE.Object3D,this.cellVectorLines=new THREE.Object3D,this.angleArcs=new THREE.Object3D,this.root.add(this.cellVectorLines),this.root.add(this.atoms),this.root.add(this.bonds),this.sceneStructure.add(this.root),this.basisVectors=this.createBasisVectors(t);let l=[],h=[];if(void 0!==s)for(let e=0;e<s.length;++e){let t=s[e],i=(new THREE.Vector3).fromArray(t),o=i.x,n=i.y,a=i.z;this.options.structure.wrap&&(r[0]&&this.almostEqual(1,o,this.basisVectors[0],this.wrapTolerance)&&(o-=1),r[1]&&this.almostEqual(1,n,this.basisVectors[1],this.wrapTolerance)&&(n-=1),r[2]&&this.almostEqual(1,a,this.basisVectors[2],this.wrapTolerance)&&(a-=1)),i=new THREE.Vector3(o,n,a),l.push(i);let c=new THREE.Vector3;c.add(this.basisVectors[0].clone().multiplyScalar(i.x)),c.add(this.basisVectors[1].clone().multiplyScalar(i.y)),c.add(this.basisVectors[2].clone().multiplyScalar(i.z)),h.push(c)}else if(void 0!==i)for(let e=0;e<i.length;++e){let s=i[e],o=(new THREE.Vector3).fromArray(s);h.push(o);let n=new THREE.Matrix3;n.set(t[0][0],t[0][1],t[0][2],t[1][0],t[1][1],t[1][2],t[2][0],t[2][1],t[2][2]);let r=(new THREE.Matrix3).getInverse(n),a=o.clone().applyMatrix3(r);l.push(a)}let c=0,d=[],u=r[0],p=r[1],m=r[2];if(u&&p&&m)c=3;else if(u||p||m)for(let e=0;e<3;++e){let t=r[e],s=r[(e+1)%3],i=r[(e+2)%3];if(t&&!s&&!i){c=1,d.push(e);break}if(t&&s&&!i){c=2,d.push(e),d.push((e+1)%3);break}}else c=0;0===c&&this.setup0D(l,h,o),1===c?this.setup1D(l,h,o,r,d):2===c?this.setup2D(l,h,o,r,d):3===c&&this.setup3D(l,h,o),this.createVisualizationBoundaryPositions(this.atomPos,o),this.createBonds(a);let E,w=this.options.structure.viewCenter;return"COP"===w?E=this.calculateCOP(this.atomPos):"COC"===w?E=(new THREE.Vector3).add(this.basisVectors[0]).add(this.basisVectors[1]).add(this.basisVectors[2]).multiplyScalar(.5):Array.isArray(w)&&(E=(new THREE.Vector3).fromArray(w)),this.setViewCenter(E),this.translate(this.options.structure.translation),this.setZoom(this.options.controls.zoomLevel),this.options.structure.createLegend&&this.createElementLegend(),!0}calculateCOP(e){let t=e.length,s=new THREE.Vector3;for(let i=0;i<t;++i){let t=e[i];s.add(t)}return s.divideScalar(t),s}setViewCenter(e){this.cornerPoints.position.sub(e),this.atoms.position.sub(e),this.bonds.position.sub(e),this.latticeParameters.position.sub(e),this.angleArcs.position.sub(e),this.convCell.position.sub(e),this.render()}translate(e){let t=(new THREE.Vector3).fromArray(e);this.atoms.position.add(t),this.bonds.position.add(t),this.render()}setZoom(e){this.camera.zoom=e,this.render()}setupStatic(){if(this.options.structure.createLegend){var e=document.createElement("div");e.id="elementlegend",this.elementLegend=e,this.rootElement.appendChild(e)}}setupLights(){this.lights=[];let e=new THREE.DirectionalLight(16777215,.45);e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.position.set(0,0,20),this.sceneStructure.add(e),this.lights.push(e);let t=new THREE.DirectionalLight(16777215,.3);t.shadow.mapSize.width=2048,t.shadow.mapSize.height=2048,t.position.set(-20,0,-20),this.sceneStructure.add(t),this.lights.push(t);let s=new THREE.DirectionalLight(16777215,.25);s.shadow.mapSize.width=2048,s.shadow.mapSize.height=2048,s.position.set(20,0,-20),this.sceneStructure.add(s),this.lights.push(s);let i=new THREE.AmbientLight(4210752,1.7);this.sceneStructure.add(i)}toggleElementLegend(e){this.elementLegend.style.display=e?"flex":"None"}toggleLatticeParameters(e){this.latticeParameters.visible=e,this.cellVectorLines.visible=e,this.angleArcs.visible=e,this.render()}toggleCell(e){void 0!==this.convCell&&(this.convCell.visible=e),void 0!==this.primCell&&(this.primCell.visible=e),this.render()}toggleBonds(e){this.bonds.visible=e,this.render()}toggleShadows(e){this.renderer.shadowMap.enabled=e;for(let t=0;t<this.lights.length;++t){this.lights[t].castShadow=e}for(let t=0;t<this.atomFills.length;++t){let s=this.atomFills[t];s.receiveShadow=e,s.castShadow=e,s.material.needsUpdate=!0}for(let t=0;t<this.bondFills.length;++t){let s=this.bondFills[t];s.receiveShadow=e,s.castShadow=e,s.material.needsUpdate=!0}this.render(),this.render()}createElementLegend(){for(;this.elementLegend.firstChild;)this.elementLegend.removeChild(this.elementLegend.firstChild);let e=[];for(let t in this.elements)this.elements.hasOwnProperty(t)&&e.push([t,this.elements[t][0],this.elements[t][1]]);e.sort((function(e,t){let s=e[0],i=t[0];return s<i?-1:s>i?1:0}));for(let t=0;t<e.length;++t){let s=e[t][0],i=e[t][1].toString(16),o=6-i.length;i="#"+Array(o+1).join("0")+i;let n=50*e[t][2],r=document.createElement("div");r.className="elementlabel",r.style.backgroundColor=i,r.style.height=n+"px",r.style.width=n+"px",r.style.textAlign="center",r.style.verticalAlign="middle",r.style.lineHeight=n+"px",r.style.borderRadius=n/2+"px",r.textContent=s,this.elementLegend.appendChild(r)}}createLatticeParameters(e,t,s){this.latticeParameters=new THREE.Object3D,this.axisLabels=[],this.sceneInfo.add(this.latticeParameters),this.sceneInfo.add(this.angleArcs);let i=0;for(let e=0;e<t.length;++e)t[e]&&++i;let o,n,r=(e,t,s,i=!0)=>{let o=document.createElement("canvas");o.width=256,o.height=256;let n=o.getContext("2d");n.fillStyle=s,n.font="155px "+this.options.style.font.family,n.textAlign="center",i&&(n.font="160px "+this.options.style.font.family,n.lineWidth=8,n.strokeStyle="#000000",n.strokeText(t,128,128)),n.fillText(t,128,128);let r=new THREE.Texture(o);r.needsUpdate=!0;let a=new THREE.SpriteMaterial({map:r}),l=new THREE.Sprite(a);l.position.copy(e);return l.scale.set(1.5,1.5,1),l},a=(new THREE.LineBasicMaterial({color:"#000000",linewidth:1.5}),["#C52929","#47A823","#3B5796"]),l=-1,h=["a","b","c"],c=["γ","α","β"];2===i&&(o=s[0],n=s[1]);for(let s=0;s<3;++s){if(!t[s])continue;l+=1;let d,u,p,m=h[l],E=a[l],w=c[l],g=e[s],y=e[(s+1)%3].clone(),b=e[(s+2)%3].clone(),v=new THREE.Vector3(0,0,0),f=g.clone(),R=f.clone().multiplyScalar(.5);if(0==y.length())u=(new THREE.Vector3).crossVectors(g,b),d=(new THREE.Vector3).crossVectors(g,u);else if(0==b.length())p=(new THREE.Vector3).crossVectors(g,y),d=(new THREE.Vector3).crossVectors(g,b);else{let e=(new THREE.Vector3).crossVectors(g,y),t=(new THREE.Vector3).crossVectors(g,b);d=(new THREE.Vector3).sub(e).add(t)}if(d.normalize(),d.multiplyScalar(.8),R.add(d),3===i)m=r(R,m,E),this.latticeParameters.add(m),this.axisLabels.push(m);else if(2===i){let e=r(R,m,E);this.latticeParameters.add(e),this.axisLabels.push(e),w="γ"}else{let e=r(R,"a",E);this.latticeParameters.add(e),this.axisLabels.push(e)}let T=new THREE.MeshBasicMaterial({color:E,transparent:!0,opacity:.75}),H=g.clone(),V=this.createCylinder(v.clone(),H.clone().add(v),.09,10,T);this.latticeParameters.add(V);let S=new THREE.MeshBasicMaterial({color:"#000000"}),C=this.basisVectors[s].clone(),P=C.clone().multiplyScalar(1+1.3/C.length()),_=(g.clone(),this.createCylinder(v.clone(),P,.02,10,S));this.latticeParameters.add(_);let x=new THREE.CylinderGeometry(0,.1,.5,12),M=new THREE.MeshBasicMaterial({color:0}),A=new THREE.Mesh(x,M);if(A.position.copy(f).multiplyScalar(1+1.3/f.length()),A.lookAt(new THREE.Vector3),A.rotateX(-Math.PI/2),this.latticeParameters.add(A),1===i)continue;if(2===i&&(s!=o||(s+1)%3!=n))continue;let z=new THREE.LineDashedMaterial({color:0,linewidth:2,dashSize:.2,gapSize:.1}),L=(new THREE.Vector3).crossVectors(g,y),D=g.angleTo(y),j=Math.max(Math.min(1/4*g.length(),1/4*y.length()),1),O=new THREE.EllipseCurve(0,0,j,j,0,D,!1).getSpacedPoints(20),W=(new THREE.Geometry).setFromPoints(O),k=new THREE.Line(W,z);k.computeLineDistances();new THREE.Vector3(0,1,0);let F=new THREE.Vector3(1,0,0),I=(new THREE.Vector3(0,0,1),(new THREE.Quaternion).setFromUnitVectors(F,g.clone().normalize()));k.quaternion.copy(I);let B=W.vertices[W.vertices.length-1];k.updateMatrixWorld();let q=k.localToWorld(B.clone()),Z=g,N=(new THREE.Vector3).crossVectors(Z,q),G=L.angleTo(N);(new THREE.Vector3).crossVectors(y,q).dot(Z)>0&&(G=-G),k.rotateX(G),k.updateMatrixWorld(),k.updateMatrix();let Q=k.localToWorld(W.vertices[9].clone()),X=Q.length();Q.multiplyScalar(1+.3/X);let Y=r(Q,w.toString(),"#FFFFFF",!0);this.latticeParameters.add(Y),this.axisLabels.push(Y),this.angleArcs.add(k)}}createBasisVectors(e){let t=[];for(let s=e.length,i=0;i<s;++i){let s=e[i],o=(new THREE.Vector3).fromArray(s);t.push(o)}return t}createVisualizationBoundaryPositions(e,t){let s=-1/0,i=-1/0,o=-1/0,n=1/0,r=1/0,a=1/0,l=0;for(let h=e.length,c=0;c<h;++c){let h=e[c],d=h.x;d>s&&(s=d),d<n&&(n=d);let u=h.y;u>i&&(i=u),u<r&&(r=u);let p=h.z;p>o&&(o=p),p<a&&(a=p);let m=this.elementRadii[t[c]];m>l&&(l=m)}let h=new THREE.Vector3(n-l,r-l,a-l),c=[new THREE.Vector3(s-n+2*l,0,0),new THREE.Vector3(0,i-r+2*l,0),new THREE.Vector3(0,0,o-a+2*l)],d=this.createCornerPoints(h,c),u=new THREE.Points(d);u.visible=!1,this.cornerPoints=u,this.root.add(this.cornerPoints)}createVisualizationBoundaryCell(e,t){let s=this.createCornerPoints(e,t),i=new THREE.Points(s);i.visible=!1,this.cornerPoints=i,this.root.add(this.cornerPoints)}createConventionalCell(e,t){let s=this.createCell(new THREE.Vector3,this.basisVectors,e,0,1.5,!1);s.visible=t,this.convCell=s,this.root.add(this.convCell)}createPrimitiveCell(e,t){if(null!=this.primitiveVectors){let s=this.createCell(new THREE.Vector3,this.primitiveVectors,e,0,1.5,!0);s.visible=t,this.primCell=s,this.root.add(this.primCell)}}createCell(e,t,s,i,o,n){let r,a=new THREE.Object3D;r=n?new THREE.LineDashedMaterial({color:i,linewidth:o,dashSize:.1,gapSize:.1}):new THREE.LineBasicMaterial({color:i,linewidth:o});let l=new THREE.LineDashedMaterial({color:"#999999",linewidth:o,dashSize:.1,gapSize:.1}),h=!0;for(let e=0;e<3;++e){t[e].length()>.001&&!s[e]&&(h=!1)}for(let i=t.length,o=0;o<i;++o){let n=t[o].clone(),c=r.clone(),d=!s[o];if(!d||!h){d&&(c=l.clone());let t=new THREE.Geometry;t.vertices.push(e.clone(),n.clone().add(e));let s=new THREE.Line(t,c);a.add(s),s.computeLineDistances()}let u=t[(o+1)%i].clone(),p=!s[o]||!s[(o+1)%3];if(!p||!h){let t=r.clone();p&&(t=l.clone());let s=new THREE.Geometry;s.vertices.push(u.clone().add(e),n.clone().add(u).add(e));let i=new THREE.Line(s,t);a.add(i),i.computeLineDistances()}let m=t[(o+2)%i].clone(),E=!s[o]||!s[(o+2)%3];if(!E||!h){let t=r.clone();E&&(t=l.clone());let s=new THREE.Geometry;s.vertices.push(m.clone().add(e),n.clone().add(m).add(e));let i=new THREE.Line(s,t);a.add(i),i.computeLineDistances()}let w=!s[o]||!s[(o+2)%3]||!s[(o+1)%3];if(!w||!h){let t=r.clone();w&&(t=l.clone());let s=new THREE.Geometry;s.vertices.push(u.clone().add(m).add(e),n.clone().add(u).add(m).add(e));let i=new THREE.Line(s,t);a.add(i),i.computeLineDistances()}}return a}setupInitialView1D(e){let t;this.root.updateMatrixWorld();for(let s=0;s<e.length;++s){e[s]&&(t=this.basisVectors[s])}let s=new THREE.Vector3(1,0,0),i=(new THREE.Quaternion).setFromUnitVectors(s,t.clone().normalize());i.conjugate(),this.root.quaternion.premultiply(i),this.sceneInfo.quaternion.premultiply(i);let o=new THREE.Vector3(0,1,0),n=new THREE.Vector3(1,0,0);n.applyQuaternion(this.camera.quaternion),o.applyQuaternion(this.camera.quaternion);let r=Math.PI/4;this.rotateAroundWorldAxis(this.root,o,r),this.rotateAroundWorldAxis(this.sceneInfo,o,r);let a=Math.PI/9;this.rotateAroundWorldAxis(this.root,n,a),this.rotateAroundWorldAxis(this.sceneInfo,n,a)}setupInitialView2D(e,t){let s=this.basisVectors[t[0]].clone(),i=[1,1,1];for(let e=0;e<t.length;++e){i[t[e]]=0}i=(new THREE.Vector3).fromArray(i),this.root.updateMatrixWorld();let o=new THREE.Vector3(0,0,1),n=(new THREE.Quaternion).setFromUnitVectors(i.clone().normalize(),o);this.root.quaternion.premultiply(n),this.sceneInfo.quaternion.premultiply(n),s=s.clone().applyQuaternion(n),i=i.clone().applyQuaternion(n),o=new THREE.Vector3(1,0,0),n=(new THREE.Quaternion).setFromUnitVectors(s.clone().normalize(),o),this.root.quaternion.premultiply(n),this.sceneInfo.quaternion.premultiply(n),this.root.updateMatrixWorld(),this.sceneInfo.updateMatrixWorld();let r=new THREE.Vector3(1,0,0);r.applyQuaternion(this.camera.quaternion);let a=-Math.PI/6;this.rotateAroundWorldAxis(this.root,r,a),this.rotateAroundWorldAxis(this.sceneInfo,r,a)}setupInitialView3D(){this.basisVectors[0];let e=this.basisVectors[1],t=this.basisVectors[2];this.root.updateMatrixWorld();let s=new THREE.Vector3(0,1,0),i=(new THREE.Quaternion).setFromUnitVectors(t.clone().normalize(),s);this.root.quaternion.premultiply(i),this.sceneInfo.quaternion.premultiply(i),this.root.updateMatrixWorld(),this.sceneInfo.updateMatrixWorld(),e=e.clone().applyQuaternion(i),t=t.clone().applyQuaternion(i);let o=(new THREE.Vector3).crossVectors(e,t),n=new THREE.Vector3(0,0,1),r=(new THREE.Quaternion).setFromUnitVectors(o.clone().normalize(),n);this.root.quaternion.premultiply(r),this.sceneInfo.quaternion.premultiply(r),this.root.updateMatrixWorld(),this.sceneInfo.updateMatrixWorld(),e=e.clone().applyQuaternion(r),t=t.clone().applyQuaternion(r);let a=new THREE.Vector3(0,0,-1);a.applyQuaternion(this.camera.quaternion);let l=(new THREE.Vector3).crossVectors(a,e);l.normalize();let h=-Math.PI/3;this.rotateAroundWorldAxis(this.root,l,h),this.rotateAroundWorldAxis(this.sceneInfo,l,h);let c=(new THREE.Vector3).crossVectors(a,t);c.normalize();let d=Math.PI/6;this.rotateAroundWorldAxis(this.root,c,d),this.rotateAroundWorldAxis(this.sceneInfo,c,d)}createAtoms(e,t,s){this.elements={},this.atomPos=[],this.atomNumbers=[],this.atomFills=[],this.atomOutlines=[];let i=this.basisVectors[0],o=this.basisVectors[1],n=this.basisVectors[2],r={};for(let a=e.length,l=0;l<a;++l){let a=e[l],h=t[l];this.addAtom(l,a,h,r);let c=this.elementNames[h-1];if(this.elements[c]=[this.elementColors[h],this.elementRadii[h]],s){let e=a.x,t=a.y,s=a.z,c=this.almostEqual(0,e,i,this.wrapTolerance),d=this.almostEqual(0,t,o,this.wrapTolerance),u=this.almostEqual(0,s,n,this.wrapTolerance);c&&d&&u?(this.addAtom(l,new THREE.Vector3(1,0,0),h,r),this.addAtom(l,new THREE.Vector3(0,1,0),h,r),this.addAtom(l,new THREE.Vector3(0,0,1),h,r),this.addAtom(l,new THREE.Vector3(1,1,0),h,r),this.addAtom(l,new THREE.Vector3(0,1,1),h,r),this.addAtom(l,new THREE.Vector3(1,0,1),h,r),this.addAtom(l,new THREE.Vector3(1,1,1),h,r)):c&&d&&!u?(this.addAtom(l,a.clone().add(new THREE.Vector3(1,0,0)),h,r),this.addAtom(l,a.clone().add(new THREE.Vector3(0,1,0)),h,r),this.addAtom(l,a.clone().add(new THREE.Vector3(1,1,0)),h,r)):!c&&d&&u?(this.addAtom(l,a.clone().add(new THREE.Vector3(0,1,0)),h,r),this.addAtom(l,a.clone().add(new THREE.Vector3(0,0,1)),h,r),this.addAtom(l,a.clone().add(new THREE.Vector3(0,1,1)),h,r)):c&&!d&&u?(this.addAtom(l,a.clone().add(new THREE.Vector3(1,0,0)),h,r),this.addAtom(l,a.clone().add(new THREE.Vector3(0,0,1)),h,r),this.addAtom(l,a.clone().add(new THREE.Vector3(1,0,1)),h,r)):!c||d||u?c||!d||u?c||d||!u||this.addAtom(l,a.clone().add(new THREE.Vector3(0,0,1)),h,r):this.addAtom(l,a.clone().add(new THREE.Vector3(0,1,0)),h,r):this.addAtom(l,a.clone().add(new THREE.Vector3(1,0,0)),h,r)}}}createBonds(e="auto"){if(this.bondFills=[],Array.isArray(e))for(let t of e){let e=t[0],s=t[1],i=this.atomPos[e],o=this.atomPos[s];this.addBond(e,s,i,o)}else if("auto"===e){let e=this.atomPos.length;for(let t=0;t<e;++t)for(let s=0;s<e;++s)if(s>t){let e=this.atomPos[t],i=this.atomPos[s],o=this.atomNumbers[t],n=this.atomNumbers[s],r=i.clone().sub(e).length(),a=this.options.structure.radiusScale*this.elementRadii[o],l=this.options.structure.radiusScale*this.elementRadii[n];r<=1.1*this.options.structure.bondScale*(a+l)&&this.addBond(t,s,e,i)}}}almostEqual(e,t,s,i){let o=t-e;return Math.abs(s.clone().multiplyScalar(o).length())<i}addBond(e,t,s,i){let o=new THREE.MeshPhongMaterial({color:16777215,shininess:30}),n=this.createCylinder(s,i,.08,10,o);n.name="fill",this.bondFills.push(n);let r=new THREE.MeshBasicMaterial({color:0,side:THREE.BackSide}),a=this.createCylinder(s,i,.1,10,r);a.name="outline";let l=new THREE.Group;l.name="bond"+e+"-"+t,l.add(n),l.add(a),this.bonds.add(l)}createAtom(e,t,s,i=!0){if(!(t in s)){let e=this.options.structure.radiusScale*this.elementRadii[t],i=165,o=Math.ceil(360/(180-i)),n=this.elementColors[t],r=new THREE.SphereGeometry(e,o,o),a=new THREE.MeshPhongMaterial({color:n,shininess:30}),l=new THREE.Mesh(r,a),h=.03/e+1,c=new THREE.SphereGeometry(e*h,o,o),d=new THREE.MeshBasicMaterial({color:0,side:THREE.BackSide}),u=new THREE.Mesh(c,d);s[t]={atom:l,outline:u}}let o=s[t],n=new THREE.Vector3;i?(n.add(this.basisVectors[0].clone().multiplyScalar(e.x)),n.add(this.basisVectors[1].clone().multiplyScalar(e.y)),n.add(this.basisVectors[2].clone().multiplyScalar(e.z))):n.copy(e);let r=o.atom.clone();r.position.copy(n);let a=o.outline.clone();return a.position.copy(n),[r,a,n]}addAtom(e,t,s,i,o=!0){let n=this.createAtom(t,s,i,o),r=n[0],a=n[1],l=n[2],h=new THREE.Group;h.name="atom"+e,r.name="fill",a.name="outline",h.add(r),h.add(a),this.atoms.add(h),this.atomFills.push(r),this.atomOutlines.push(a),this.atomPos.push(l),this.atomNumbers.push(s)}render(){let e=this.rootElement,t=e.clientWidth,s=e.clientHeight,i=new THREE.Vector3(1,0,0),o=new THREE.Vector3(0,0,0),n=[i,o];for(let e=0;e<n.length;++e){let i=n[e];this.camera.localToWorld(i),i.project(this.camera),i.x=Math.round((i.x+1)*t/2),i.y=Math.round((1-i.y)*s/2)}let r=(new THREE.Vector3).subVectors(o,i).length(),a=8/Math.pow(r,.5);if(void 0!==this.axisLabels)for(let e=0;e<this.axisLabels.length;++e){this.axisLabels[e].scale.set(a,a,1)}super.render()}setup0D(e,t,s){this.createConventionalCell([!1,!1,!1],this.options.structure.showCell),this.createPrimitiveCell([!1,!1,!1],this.options.structure.showCell),this.createAtoms(e,s,!1),this.createLatticeParameters(this.basisVectors,[!1,!1,!1])}setup1D(e,t,s,i,o){let n=o[0],r=new THREE.Vector3;r.setComponent(n,1);let a=this.basisVectors[n].clone(),l=this.getRepetitions(a,15),h=[],c=[];for(let t=1;t<=l;++t){let i=r.clone().multiplyScalar(t);for(let t=0;t<e.length;++t){let o=(new THREE.Vector3).copy(e[t]);o.add(i);let n=s[t];h.push(o),c.push(n)}let o=r.clone().multiplyScalar(-t);for(let t=0;t<e.length;++t){let i=(new THREE.Vector3).copy(e[t]);i.add(o);let n=s[t];h.push(i),c.push(n)}}e.push.apply(e,h),s.push.apply(s,c),this.options.structure.showCell&&(this.createConventionalCell(i),this.createPrimitiveCell(i)),this.createAtoms(e,s,!1),this.createLatticeParameters(this.basisVectors,i),this.setupInitialView1D(i)}getRepetitions(e,t){let s=e.length();return Math.max(Math.floor(t/s)-1,1)}setup2D(e,t,s,i,o){let n=o[0],r=o[1],a=new THREE.Vector3;a.setComponent(n,1);let l=new THREE.Vector3;l.setComponent(r,1);let h=this.basisVectors[n].clone(),c=this.basisVectors[r].clone(),d=0,u=0;this.options.structure.allowRepeat&&(d=this.getRepetitions(h,12),u=this.getRepetitions(c,12));let p=[],m=[];for(let t=0;t<=d;++t)for(let i=0;i<=u;++i)if(0!=t||0!=i){let o=a.clone().multiplyScalar(t),n=l.clone().multiplyScalar(i);for(let t=0;t<e.length;++t){let i=(new THREE.Vector3).copy(e[t]);i.add(o),i.add(n);let r=s[t];p.push(i),m.push(r)}}e.push.apply(e,p),s.push.apply(s,m),this.createConventionalCell(i,this.options.structure.showCell),this.createPrimitiveCell(i,this.options.structure.showCell),this.createAtoms(e,s,!1),this.createLatticeParameters(this.basisVectors,i,o),this.setupInitialView2D(i,o)}setup3D(e,t,s){this.createConventionalCell([!0,!0,!0],this.options.structure.showCell),this.createPrimitiveCell([!0,!0,!0],this.options.structure.showCell),this.createAtoms(e,s,this.options.structure.showCopies),this.createLatticeParameters(this.basisVectors,[!0,!0,!0]),this.setupInitialView3D()}}class E extends p{setupScenes(){this.scenes=[],this.sceneZone=new THREE.Scene,this.scenes.push(this.sceneZone),this.sceneInfo=new THREE.Scene,this.scenes.push(this.sceneInfo)}setupLights(){let e=new THREE.DirectionalLight(16777215,.05);e.position.set(0,0,30),this.sceneZone.add(e);let t=new THREE.AmbientLight(4210752,4.1);this.sceneZone.add(t)}setupVisualization(e){let t=e.vertices,s=e.faces,i=e.basis,o=e.segments,n=e.labels;return this.basis=e.basis,t&&s&&i&&o?(n||console.log("No labels provided for Brillouin zone viewer."),this.createBrillouinZone(t,s,i,o,n),this.setupInitialView(),!0):(console.log("The data given for the Brillouin zone viewer is incomplete."),!1)}handleSettings(e){let t={controls:{rotateSpeed:40,enablePan:!1},view:{fitMargin:.01},brillouinZone:{segments:{color:"#E56400"}}};this.fillOptions(e,t),super.handleSettings(t)}setupInitialView(){let e=new THREE.Vector3(0,1,0),t=new THREE.Vector3(1,0,0),s=new THREE.Vector3(0,0,1),i=(new THREE.Vector3).fromArray(this.basis[0]),o=(new THREE.Quaternion).setFromUnitVectors(e,i.clone().normalize());o.conjugate(),this.info.quaternion.copy(o),this.zone.quaternion.copy(o),this.info.updateMatrixWorld(),this.zone.updateMatrixWorld();let n=new THREE.Vector3,r=this.labelPoints.length;for(let e=0;e<r;++e){let t=this.labelPoints[e];n.add(t.getWorldPosition(new THREE.Vector3))}n.multiplyScalar(1/r),n.y=0;let a=(new THREE.Quaternion).setFromUnitVectors(s,n.clone().normalize());a.conjugate(),this.info.quaternion.premultiply(a),this.zone.quaternion.premultiply(a);let l=new THREE.Quaternion;l.setFromAxisAngle(t,Math.PI/8),this.info.quaternion.premultiply(l),this.zone.quaternion.premultiply(l)}createBrillouinZone(e,t,s,i,o){this.zone=new THREE.Object3D,this.zone.name="zone",this.sceneZone.add(this.zone),this.info=new THREE.Object3D,this.info.name="info",this.sceneInfo.add(this.info);let n=new THREE.Geometry,r=new THREE.MeshLambertMaterial({color:15658734,side:THREE.DoubleSide,transparent:!0,opacity:.8}),a=new THREE.LineBasicMaterial({color:53687091,linewidth:2});for(let t=0;t<e.length;++t){let s=e[t];n.vertices.push((new THREE.Vector3).fromArray(s).multiplyScalar(1e-10))}let l={};for(let s=0;s<t.length;++s){let i=t[s],o=i.length;for(let t=0;t<o;++t){let s=i[t],r=i[(t+1)%o],h=[s,r],c=[r,s];if(!l.hasOwnProperty(h.toString())&&!l.hasOwnProperty(c.toString())){l[h.toString()]=!0,l[c.toString()]=!0;let t=new THREE.Geometry;t.vertices.push((new THREE.Vector3).fromArray(e[s]).multiplyScalar(1e-10),(new THREE.Vector3).fromArray(e[r]).multiplyScalar(1e-10));let i=new THREE.Line(t,a);this.zone.add(i)}if(t<o-2){let e=new THREE.Face3(i[0],i[(t+1)%o],i[(t+2)%o]);n.faces.push(e)}}}n.computeFaceNormals();let h=(e,t)=>{let s=document.createElement("canvas");s.width=256,s.height=256;let i=s.getContext("2d");i.fillStyle="#000000",i.font="90px "+this.options.style.font.family,i.textAlign="center",i.fillText(t,128,128);let o=new THREE.Texture(s);o.needsUpdate=!0;let n=new THREE.SpriteMaterial({map:o}),r=new THREE.Sprite(n);r.position.copy(e);return r.scale.set(1/11,1/11,1),r};for(let e=0;e<3;++e){let t=.7,i=s[e],o=new THREE.Vector3(0,0,0),n=(new THREE.Vector3).fromArray(i).multiplyScalar(1e-10).multiplyScalar(t),r=new THREE.Geometry;r.vertices.push(o,n);let a=new THREE.LineDashedMaterial({color:0,linewidth:.1,dashSize:.005,gapSize:.005}),l=new THREE.Line(r,a);l.computeLineDistances(),this.info.add(l);let c=.02,d=(new THREE.Vector3).copy(n).multiplyScalar(1+c/n.length()),u="";switch(e){case 0:u="b₁";break;case 1:u="b₂";break;case 2:u="b₃"}u=h(d,u),this.info.add(u);let p=new THREE.CylinderGeometry(0,.003,.012,12),m=new THREE.MeshBasicMaterial({color:0}),E=new THREE.Mesh(p,m);E.position.copy(n),E.lookAt(new THREE.Vector3),E.rotateX(-Math.PI/2),this.info.add(E)}let c=[].concat.apply([],s),d=(new THREE.Matrix3).fromArray(c),u={},p=(e,t)=>{let s=document.createElement("canvas");s.width=256,s.height=256;let i=s.getContext("2d");i.beginPath(),i.arc(128,128,256/15,0,2*Math.PI),i.fillStyle=this.options.brillouinZone.segments.color,i.fill(),i.fillStyle="#000000",i.font="100px "+this.options.style.font.family,i.textAlign="center",i.fillText(t,s.width/2,80);let o=new THREE.Texture(s);o.needsUpdate=!0;let n=new THREE.SpriteMaterial({map:o}),r=new THREE.Sprite(n);r.position.copy(e);return r.scale.set(1/15,1/15,1),r},m=new THREE.LineBasicMaterial({color:this.options.brillouinZone.segments.color,linewidth:3}),E=new THREE.Geometry;this.labelPoints=[];for(let e=0;e<i.length;++e){let t=i[e],s=t.length,n=[0,s-1];for(let i of n){let n=(new THREE.Vector3).fromArray(t[i]).multiplyScalar(1e-10);if(n.applyMatrix3(d),E.vertices.push(n),o&&(0===i||i===s-1)){let t="";0===i?t=o[e][0]:i===s-1&&(t=o[e][1]);let r=!1;for(let e=0;e<this.labelPoints.length;++e){let t=this.labelPoints[e].position;(new THREE.Vector3).copy(n).addScaledVector(t,-1).length()<1e-5&&(r=!0)}if(!r){u[t]=!0;let e=p(n,t);this.info.add(e),this.labelPoints.push(e)}}}}let w=new THREE.Line(E,m);this.info.add(w);let g=new THREE.Mesh(n,r);this.zone.add(g),this.cornerPoints=new THREE.Points(n),this.cornerPoints.visible=!0}}}]);