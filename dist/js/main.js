!function(e){var t={};function s(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,s),o.l=!0,o.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)s.d(i,o,function(t){return e[t]}.bind(null,o));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){e.exports=s(1)},function(e,t,s){"use strict";s.r(t);class i{constructor(e,t={},s=!1){this.hostElement=e,this.saveBuffer=s,this.scenes=[],this.cameraWidth=10,this.fitMargin=10,this.options={},this.handleSettings(t),this.setupRootElement(),this.setupRenderer(),this.setupScenes(),this.setupStatic(),this.setupCamera(),this.setupControls(),this.setupHostElement(e),this.options.autoResize&&window.addEventListener("resize",this.onWindowResize.bind(this),!1)}handleSettings(e){this.options.enableZoom=void 0===e.enableZoom||e.enableZoom,this.options.enableRotate=void 0===e.enableRotate||e.enableRotate,this.options.enablePan=void 0===e.enablePan||e.enablePan,this.options.panSpeed=void 0===e.panSpeed?10:e.panSpeed,this.options.zoomSpeed=void 0===e.zoomSpeed?2.5:e.zoomSpeed,this.options.rotateSpeed=void 0===e.rotateSpeed?2.5:e.rotateSpeed,this.options.autoResize=void 0===e.autoResize||e.autoResize}load(e){this.clear(),this.setupScenes(),this.setupLights(),this.setupCamera(),this.setupControls();let t=this.setupVisualization(e);return this.fitToCanvas(),this.render(),this.animate(),t}loadJSON(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(),200===t.status&&this.load(JSON.parse(t.responseText))}setupStatic(){}setupScenes(){this.scenes=[],this.scene=new THREE.Scene,this.scenes.push(this.scene)}clear(){this.clearScenes(),this.scenes=null,this.controls=null,this.camera=null,this.cornerPoints=null}clearScenes(){for(let e=0;e<this.scenes.length;++e){let t=this.scenes[e];for(t.traverse((function(e){let t=e.geometry,s=e.material,i=e.texture;t&&t.dispose(),s&&s.dispose(),i&&i.dispose()}));t.children.length;){let e=t.children[0];t.remove(e)}}}takeScreenShot(e){let t;try{let s="image/jpeg",i="image/octet-stream",o=(t=this.renderer.domElement.toDataURL(s)).replace(s,i);e+=".jpg";let n=document.createElement("a");"string"==typeof n.download?(document.body.appendChild(n),n.download=e,n.href=o,n.click(),document.body.removeChild(n)):location.replace(uri)}catch(e){return void console.log(e)}}webglAvailable(){try{let e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}setupRenderer(){this.webglAvailable()?this.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0,preserveDrawingBuffer:this.saveBuffer}):this.renderer=new THREE.CanvasRenderer({alpha:!0,antialias:!0,preserveDrawingBuffer:this.saveBuffer}),this.renderer.shadowMapEnabled=!1,this.renderer.shadowMapType=THREE.PCFSoftShadowMap,this.renderer.setSize(this.rootElement.clientWidth,this.rootElement.clientHeight),this.renderer.setClearColor(16777215,0),this.rootElement.appendChild(this.renderer.domElement),this.renderer.autoClear=!1}setupCamera(){let e=this.rootElement.clientWidth/this.rootElement.clientHeight,t=this.cameraWidth,s=t/e;this.camera=new THREE.OrthographicCamera(t/-2,t/2,s/2,s/-2,-100,1e3),this.camera.name="camera",this.camera.position.z=20}setupRootElement(){this.rootElement=document.createElement("div"),this.rootElement.style.width="100%",this.rootElement.style.height="100%",this.rootElement.style.position="relative"}setupHostElement(e){if(this.hostElement)for(;this.hostElement.firstChild;)this.hostElement.removeChild(this.hostElement.firstChild);e.appendChild(this.rootElement),this.resizeCanvasToHostElement()}changeHostElement(e){this.setupHostElement(e),this.fitToCanvas(),this.render()}setupControls(){let e=new THREE.OrthographicControls(this.camera,this.rootElement);e.rotateSpeed=this.options.rotateSpeed,e.zoomSpeed=this.options.zoomSpeed,e.panSpeed=this.options.panSpeed,e.enableZoom=this.options.enableZoom,e.enablePan=this.options.enablePan,e.enableRotate=this.options.enableRotate,e.staticMoving=!0,e.dynamicDampingFactor=.25,e.keys=[65,83,68],e.addEventListener("change",this.render.bind(this)),this.controls=e}fitToCanvas(){this.scenes.forEach(e=>e.updateMatrixWorld());let e=this.rootElement,t=e.clientWidth,s=e.clientHeight,i=[],o=new THREE.Vector3;for(let e=this.cornerPoints.geometry.vertices.length,t=0;t<e;++t){let e=this.cornerPoints.geometry.vertices[t].clone();this.cornerPoints.localToWorld(e),o.add(e)}o.multiplyScalar(1/this.cornerPoints.geometry.vertices.length);for(let e=this.cornerPoints.geometry.vertices.length,n=0;n<e;++n){let e=this.cornerPoints.geometry.vertices[n].clone();this.cornerPoints.localToWorld(e);this.camera.zoom;this.camera.zoom=this.options.zoomLevel,this.camera.updateProjectionMatrix();let a=o.sub(e);a.project(this.camera);let l=a.x<0,r=a.y<0;e.project(this.camera);let h=this.fitMargin,c=new THREE.Vector3(0,h,0),d=new THREE.Vector3(h,0,0);c.applyQuaternion(this.camera.quaternion),d.applyQuaternion(this.camera.quaternion),r?e.add(c):e.sub(c),l?e.add(d):e.sub(d),e.x=Math.round((e.x+1)*t/2),e.y=Math.round((1-e.y)*s/2),e.z=0,i.push(e)}let n=i[0].x,a=i[0].x,l=i[0].y,r=i[0].y;for(let e=i.length,t=0;t<e;++t){let e=i[t],s=e.x,o=e.y;s>a?a=s:s<n&&(n=s),o>r?r=o:o<l&&(l=o)}let h,c=t/(a-n),d=s/(r-l);c<=1&&d<=1?h=Math.min(c,d):c>=1&&d>=1?h=Math.min(c,d):c<=1&&d>=1?h=c:d<=1&&c>=1&&(h=d),this.camera.zoom=h,this.camera.updateProjectionMatrix()}resizeCanvasToHostElement(){let e=this.rootElement.clientWidth/this.rootElement.clientHeight,t=this.cameraWidth,s=t/e;this.camera.left=-t/2,this.camera.right=t/2,this.camera.top=s/2,this.camera.bottom=-s/2,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.rootElement.clientWidth,this.rootElement.clientHeight),this.controls.handleResize(),this.render()}onWindowResize(){this.resizeCanvasToHostElement(),this.fitToCanvas(),this.render()}render(){this.renderer.clear();for(let e=0;e<this.scenes.length;++e){let t=this.scenes[e];this.renderer.render(t,this.camera),e!==this.scenes.length-1&&this.renderer.clearDepth()}}animate(){requestAnimationFrame(this.animate.bind(this)),this.controls.update()}createCylinder(e,t,s,i,o){var n=(new THREE.Vector3).subVectors(t,e);let a=n.length(),l=n.clone().divideScalar(a);var r=new THREE.ArrowHelper(l,e),h=new THREE.CylinderGeometry(s,s,a,i,0),c=new THREE.Mesh(h,o);return c.rotation.copy(r.rotation.clone()),c.position.copy((new THREE.Vector3).addVectors(e,n.multiplyScalar(.5))),c}rotateAroundWorldAxis(e,t,s){let i=new THREE.Matrix4;i.makeRotationAxis(t.normalize(),s),i.multiply(e.matrix),e.matrix=i,e.rotation.setFromRotationMatrix(e.matrix)}}class o extends i{constructor(){super(...arguments),this.fitMargin=.5,this.axisLabels=[],this.wrapTolerance=.05,this.tagColorMap={adsorbates:"0xd70000",unknowns:"0xd75f00",interstitials:"0xaf8700",substitutions:"0x0087ff",outliers:"0x0087ff"},this.elementNames=["H","He","Li","Be","B","C","N","O","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Ge","As","Se","Br","Kr","Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I","Xe","Cs","Ba","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","At","Rn","Fr","Ra","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr","Rf","Ha","Sg","Ns","Hs","Mt","Ds","Rg","Cn","Nh","Fl","Mc","Lv","Ts","Og"],this.elementNumbers={H:1,He:2,Li:3,Be:4,B:5,C:6,N:7,O:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,S:16,Cl:17,Ar:18,K:19,Ca:20,Sc:21,Ti:22,V:23,Cr:24,Mn:25,Fe:26,Co:27,Ni:28,Cu:29,Zn:30,Ga:31,Ge:32,As:33,Se:34,Br:35,Kr:36,Rb:37,Sr:38,Y:39,Zr:40,Nb:41,Mo:42,Tc:43,Ru:44,Rh:45,Pd:46,Ag:47,Cd:48,In:49,Sn:50,Sb:51,Te:52,I:53,Xe:54,Cs:55,Ba:56,La:57,Ce:58,Pr:59,Nd:60,Pm:61,Sm:62,Eu:63,Gd:64,Tb:65,Dy:66,Ho:67,Er:68,Tm:69,Yb:70,Lu:71,Hf:72,Ta:73,W:74,Re:75,Os:76,Ir:77,Pt:78,Au:79,Hg:80,Tl:81,Pb:82,Bi:83,Po:84,At:85,Rn:86,Fr:87,Ra:88,Ac:89,Th:90,Pa:91,U:92,Np:93,Pu:94,Am:95,Cm:96,Bk:97,Cf:98,Es:99,Fm:100,Md:101,No:102,Lr:103},this.missing=.2,this.elementRadii=[this.missing,.31,.28,1.28,.96,.84,.76,.71,.66,.57,.58,1.66,1.41,1.21,1.11,1.07,1.05,1.02,1.06,2.03,1.76,1.7,1.6,1.53,1.39,1.39,1.32,1.26,1.24,1.32,1.22,1.22,1.2,1.19,1.2,1.2,1.16,2.2,1.95,1.9,1.75,1.64,1.54,1.47,1.46,1.42,1.39,1.45,1.44,1.42,1.39,1.39,1.38,1.39,1.4,2.44,2.15,2.07,2.04,2.03,2.01,1.99,1.98,1.98,1.96,1.94,1.92,1.92,1.89,1.9,1.87,1.87,1.75,1.7,1.62,1.51,1.44,1.41,1.36,1.36,1.32,1.45,1.46,1.48,1.4,1.5,1.5,2.6,2.21,2.15,2.06,2,1.96,1.9,1.87,1.8,1.69,this.missing,this.missing,this.missing,this.missing,this.missing,this.missing,this.missing],this.elementColors=[16711680,16777215,14286847,13402367,12779264,16758197,9474192,3166456,16715021,9494608,11789301,11230450,9109248,12560038,1578e4,16744448,16777008,2093087,8442339,9388244,4062976,15132390,12567239,10921643,9083335,10255047,14706227,15765664,5296208,13140019,8224944,12750735,6721423,12419299,16752896,10889513,6076625,7351984,65280,9764863,9756896,7586505,5551541,3907230,2396047,687500,27013,12632256,16767375,10909043,6717568,10380213,13924864,9699476,4366e3,5707663,51456,7394559,16777159,14286791,13107143,10747847,9437127,6422471,4587463,3211207,2097095,65436,58997,54354,48952,43812,5096191,5089023,2200790,2522539,2516630,1528967,13684960,16765219,12105936,10900557,5724513,10375093,11230208,7688005,4358806,4325478,32e3,7384058,47871,41471,36863,33023,27647,5528818,7888099,9064419,10565332,11739092,11739066,11734438,12389767,13041766,13369433,13697103,14221381,14680120,15073326,15400998]}setupScenes(){this.scenes=[],this.sceneStructure=new THREE.Scene,this.scenes.push(this.sceneStructure),this.sceneInfo=new THREE.Scene,this.scenes.push(this.sceneInfo)}handleSettings(e){this.options.showParam=void 0===e.showParam||e.showParam,this.options.showLegend=void 0===e.showLegend||e.showLegend,this.options.showBonds=void 0===e.showBonds||e.showBonds,this.options.showShadows=void 0!==e.showShadows&&e.showShadows,this.options.showTags=void 0!==e.showTags&&e.showTags,this.options.showVacancies=void 0!==e.showVacancies&&e.showVacancies,this.options.showOptions=void 0===e.showOptions||e.showOptions,this.options.allowRepeat=void 0===e.allowRepeat||e.allowRepeat,this.options.showCopies=void 0!==e.showCopies&&e.showCopies,this.options.showCell=void 0===e.showCell||e.showCell,this.options.wrap=void 0===e.wrap||e.wrap,this.options.showUnit=void 0===e.showUnit||e.showUnit,this.options.radiusScale=void 0===e.radiusScale?1:e.radiusScale,this.options.bondScale=void 0===e.bondScale?1:e.bondScale,this.options.translation=void 0===e.translation?[0,0,0]:e.translation,this.options.zoomLevel=void 0===e.zoomLevel?1:e.zoomLevel,super.handleSettings(e)}setupVisualization(e){e.primitiveCell;let t=e.cell,s=e.scaledPositions,i=e.positions,n=e.atomicNumbers,a=e.chemicalSymbols,l=e.pbc,r=e.unit;this.tags=e.tags;let h=e.classification;if(!t)return console.log("No normalized cell given to the structure viewer"),!1;if(!s&&!i)return console.log("No atom positions given to the structure viewer"),!1;if(!n&&!a)return console.log("No atomicNumbers or chemicalSymbols given to the structure viewer."),!1;if(n||(n=a.map(e=>this.elementNumbers[e])),i&&i.length!=n.length)return console.log("The number of positions does not match the number of labels."),!1;if(s&&s.length!=n.length)return console.log("The number of scaled positions does not match the number of labels."),!1;if("Surface"!=h&&"Material2D"!=h&&"Class2D"!=h||(this.options.allowRepeat=!1,this.options.wrap=!1,this.options.showCopies=!1),this.options.showUnit&&null!=r&&null!=r){let e=document.createElement("div");e.style.position="fixed",e.style.top="5%",e.style.right="5%",e.style.width="25%",e.style.height="25%",this.rootElement.appendChild(e),this.unitDiv=e;let t=document.createElement("div");t.id="unitCanvas",t.style.width="100%",t.style["padding-top"]="100%",t.style.position="relative",e.appendChild(t);let s=document.createElement("div");s.style.position="absolute",s.style.top=0,s.style.left=0,s.style.bottom=0,s.style.right=0,t.appendChild(s),r.classification=h;let i=new o(s,!1,{showOptions:!1,showCopies:!1,show:!1,wrap:!1,showParam:!1,showLegend:!1});i.load(r),i.toggleElementLegend(!1)}null!=l&&null!=l||(l=[!0,!0,!0]),this.root=new THREE.Object3D,this.atoms=new THREE.Object3D,this.bonds=new THREE.Object3D,this.cellVectorLines=new THREE.Object3D,this.angleArcs=new THREE.Object3D,this.root.add(this.cellVectorLines),this.root.add(this.atoms),this.root.add(this.bonds),this.sceneStructure.add(this.root),this.basisVectors=this.createBasisVectors(t);let c=[],d=[];if(void 0!==s)for(let e=0;e<s.length;++e){let t=s[e],i=(new THREE.Vector3).fromArray(t),o=i.x,n=i.y,a=i.z;this.options.wrap&&(l[0]&&this.almostEqual(1,o,this.basisVectors[0],this.wrapTolerance)&&(o-=1),l[1]&&this.almostEqual(1,n,this.basisVectors[1],this.wrapTolerance)&&(n-=1),l[2]&&this.almostEqual(1,a,this.basisVectors[2],this.wrapTolerance)&&(a-=1)),i=new THREE.Vector3(o,n,a),c.push(i);let r=new THREE.Vector3;r.add(this.basisVectors[0].clone().multiplyScalar(i.x)),r.add(this.basisVectors[1].clone().multiplyScalar(i.y)),r.add(this.basisVectors[2].clone().multiplyScalar(i.z)),d.push(r)}else if(void 0!==i)for(let e=0;e<i.length;++e){let s=i[e],o=(new THREE.Vector3).fromArray(s);d.push(o);let n=new THREE.Matrix3;n.set(t[0][0],t[0][1],t[0][2],t[1][0],t[1][1],t[1][2],t[2][0],t[2][1],t[2][2]);let a=(new THREE.Matrix3).getInverse(n),l=o.clone().applyMatrix3(a);c.push(l)}let p=0,m=[],u=l[0],E=l[1],w=l[2];if(u&&E&&w)p=3;else if(u||E||w)for(let e=0;e<3;++e){let t=l[e],s=l[(e+1)%3],i=l[(e+2)%3];if(t&&!s&&!i){p=1,m.push(e);break}if(t&&s&&!i){p=2,m.push(e),m.push((e+1)%3);break}}else p=0;return 0===p&&this.setup0D(c,d,n),1===p?this.setup1D(c,d,n,l,m):2===p?this.setup2D(c,d,n,l,m):3===p&&this.setup3D(c,d,n),this.translate(this.options.translation),this.setZoom(this.options.zoomLevel),this.createVacancies(),this.createElementLegend(),this.optionsHandler(),!0}createVacancies(){if(this.tags){let e=this.tags.vacancies;if(e){let t=[],s=[];for(let i=0;i<e.length;++i){let o=e[i];t.push((new THREE.Vector3).fromArray(o.position)),s.push(o.label)}let i={};this.vacancyContainer=new THREE.Object3D,this.vacancyContainer.visible=!1;for(let e=t.length,o=0;o<e;++o){let e=t[o],n=s[o],a=this.createAtom(e,n,i),l=a[0];l.material.opacity=.25,l.material.transparent=!0;let r=a[1];r.material.opacity=.25,r.material.transparent=!0,this.vacancyContainer.add(l),this.vacancyContainer.add(r)}this.atoms.add(this.vacancyContainer)}}}setupStatic(){this.optionsHandler=function(){let e=this.options.showParam,t=this.options.showCell,s=this.options.showLegend,i=this.options.showBonds,o=this.options.showShadows,n=this.options.showTags,a=this.options.showVacancies,l=this.options.showOptions;this.toggleLatticeParameters(e),this.toggleCell(t),this.toggleElementLegend(s),this.toggleBonds(i),this.toggleShadows(o),this.toggleTags(n),this.toggleVacancies(a),this.toggleOptions(l)}.bind(this),this.datGui=new dat.GUI({autoPlace:!1,width:150}),this.datGui.domElement.id="datgui",this.datGui.domElement.style.display="None",this.datGui.close(),this.rootElement.appendChild(this.datGui.domElement),this.datGui.add(this.options,"showParam",!0).name("Lattice parameters").onChange(this.optionsHandler),this.datGui.add(this.options,"showCell",!0).name("Cell").onChange(this.optionsHandler),this.datGui.add(this.options,"showLegend",!0).name("Element labels").onChange(this.optionsHandler),this.datGui.add(this.options,"showBonds",!0).name("Bonds").onChange(this.optionsHandler),this.datGui.add(this.options,"showShadows",!1).name("Shadows").onChange(this.optionsHandler),this.datGui.add(this.options,"showTags",!1).name("Tags").onChange(this.optionsHandler),this.datGui.add(this.options,"showVacancies",!1).name("Vacancies").onChange(this.optionsHandler),this.datGui.add(this.options,"showOptions",!1).name("Options").onChange(this.optionsHandler);var e=document.createElement("div");e.id="elementlegend",this.elementLegend=e,this.rootElement.appendChild(e)}setupLights(){this.lights=[];let e=new THREE.DirectionalLight(16777215,.45);e.shadowMapWidth=2048,e.shadowMapHeight=2048,e.position.set(0,0,20),this.sceneStructure.add(e),this.lights.push(e);let t=new THREE.DirectionalLight(16777215,.3);t.shadowMapWidth=2048,t.shadowMapHeight=2048,t.position.set(-20,0,-20),this.sceneStructure.add(t),this.lights.push(t);let s=new THREE.DirectionalLight(16777215,.25);s.shadowMapWidth=2048,s.shadowMapHeight=2048,s.position.set(20,0,-20),this.sceneStructure.add(s),this.lights.push(s);let i=new THREE.AmbientLight(4210752,1.7);this.sceneStructure.add(i)}toggleElementLegend(e){this.elementLegend.style.display=e?"flex":"None"}toggleOptions(e){this.datGui.domElement.style.display=e?"block":"None"}toggleVacancies(e){this.vacancyContainer&&(this.vacancyContainer.visible=e,this.render())}toggleTags(e){if(this.tags){if(e)var t=this.tagColorMap.adsorbates,s=this.tagColorMap.substitutions,i=this.tagColorMap.interstitials,o=this.tagColorMap.unknowns,n=this.tagColorMap.outliers,a=1.15;else t=0,s=0,n=0,a=1;if(this.tags.additionals)for(let e=0;e<this.tags.additionals.length;++e){let t=this.tags.additionals[e],s=this.atomOutlines[t],i=s.material.clone();s.scale.set(a,a,a),i.color.setHex(n),s.material=i}if(this.tags.adsorbates)for(let e=0;e<this.tags.adsorbates.length;++e){let s=this.tags.adsorbates[e],i=this.atomOutlines[s],o=i.material.clone();i.scale.set(a,a,a),o.color.setHex(t),i.material=o}if(this.tags.substitutions)for(let e=0;e<this.tags.substitutions.length;++e){let t=this.tags.substitutions[e],i=this.atomOutlines[t],o=i.material.clone();i.scale.set(a,a,a),o.color.setHex(s),i.material=o}if(this.tags.interstitials)for(let e=0;e<this.tags.interstitials.length;++e){let t=this.tags.interstitials[e],s=this.atomOutlines[t],o=s.material.clone();s.scale.set(a,a,a),o.color.setHex(i),s.material=o}if(this.tags.unknowns)for(let e=0;e<this.tags.unknowns.length;++e){let t=this.tags.unknowns[e],s=this.atomOutlines[t],i=s.material.clone();s.scale.set(a,a,a),i.color.setHex(o),s.material=i}this.render()}}toggleLatticeParameters(e){this.latticeParameters.visible=e,this.cellVectorLines.visible=e,this.angleArcs.visible=e,this.render()}toggleCell(e){void 0!==this.convCell&&(this.convCell.visible=e),void 0!==this.primCell&&(this.primCell.visible=e),this.render()}toggleBonds(e){this.bonds.visible=e,this.render()}toggleShadows(e){this.renderer.shadowMapEnabled=e;for(let t=0;t<this.lights.length;++t){this.lights[t].castShadow=e}for(let t=0;t<this.atomFills.length;++t){let s=this.atomFills[t];s.receiveShadow=e,s.castShadow=e,s.material.needsUpdate=!0}for(let t=0;t<this.bondFills.length;++t){let s=this.bondFills[t];s.receiveShadow=e,s.castShadow=e,s.material.needsUpdate=!0}this.render(),this.render()}createElementLegend(){for(;this.elementLegend.firstChild;)this.elementLegend.removeChild(this.elementLegend.firstChild);let e=[];for(let t in this.elements)this.elements.hasOwnProperty(t)&&e.push([t,this.elements[t][0],this.elements[t][1]]);e.sort((function(e,t){let s=e[0],i=t[0];return s<i?-1:s>i?1:0}));for(let t=0;t<e.length;++t){let s=e[t][0],i=e[t][1].toString(16),o=6-i.length;i="#"+Array(o+1).join("0")+i;let n=50*e[t][2],a=document.createElement("div");a.className="elementlabel",a.style.backgroundColor=i,a.style.height=n+"px",a.style.width=n+"px",a.style.textAlign="center",a.style.verticalAlign="middle",a.style.lineHeight=n+"px",a.style.borderRadius=n/2+"px",a.textContent=s,this.elementLegend.appendChild(a)}}createLatticeParameters(e,t,s){this.latticeParameters=new THREE.Object3D,this.axisLabels=[],this.sceneInfo.add(this.latticeParameters),this.sceneInfo.add(this.angleArcs);let i=0;for(let e=0;e<t.length;++e)t[e]&&++i;function o(e,t,s,i=!0){let o=document.createElement("canvas");o.width=256,o.height=256;let n=o.getContext("2d");n.fillStyle=s,n.font="155px Arimo",n.textAlign="center",i&&(n.font="160px Arimo",n.lineWidth=8,n.strokeStyle="#000000",n.strokeText(t,128,128)),n.fillText(t,128,128);let a=new THREE.Texture(o);a.needsUpdate=!0;let l=new THREE.SpriteMaterial({map:a}),r=new THREE.Sprite(l);r.position.copy(e);return r.scale.set(1.5,1.5,1),r}new THREE.LineBasicMaterial({color:"#000000",linewidth:1.5});let n,a,l=["#C52929","#47A823","#3B5796"],r=-1,h=["a","b","c"],c=["γ","α","β"];2===i&&(n=s[0],a=s[1]);for(let s=0;s<3;++s){if(!t[s])continue;let d,p,m,u=h[r+=1],E=l[r],w=c[r],g=e[s],T=e[(s+1)%3].clone(),R=e[(s+2)%3].clone(),f=new THREE.Vector3(0,0,0),H=g.clone(),b=H.clone().multiplyScalar(.5);if(0==T.length())p=(new THREE.Vector3).crossVectors(g,R),d=(new THREE.Vector3).crossVectors(g,p);else if(0==R.length())m=(new THREE.Vector3).crossVectors(g,T),d=(new THREE.Vector3).crossVectors(g,R);else{let e=(new THREE.Vector3).crossVectors(g,T),t=(new THREE.Vector3).crossVectors(g,R);d=(new THREE.Vector3).sub(e).add(t)}if(d.normalize(),d.multiplyScalar(.8),b.add(d),3===i)u=o(b,u,E),this.latticeParameters.add(u),this.axisLabels.push(u);else if(2===i){let e=o(b,u,E);this.latticeParameters.add(e),this.axisLabels.push(e),w="γ"}else{let e=o(b,"a",E);this.latticeParameters.add(e),this.axisLabels.push(e)}let y=new THREE.MeshBasicMaterial({color:E,transparent:!0,opacity:.75}),V=g.clone(),C=this.createCylinder(f.clone(),V.clone().add(f),.09,10,y);this.latticeParameters.add(C);let v=new THREE.MeshBasicMaterial({color:"#000000"}),S=this.basisVectors[s].clone(),M=S.clone().multiplyScalar(1+1.3/S.length()),P=(g.clone(),this.createCylinder(f.clone(),M,.02,10,v));this.latticeParameters.add(P);let x=new THREE.CylinderGeometry(0,.1,.5,12),A=new THREE.MeshBasicMaterial({color:0}),L=new THREE.Mesh(x,A);if(L.position.copy(H).multiplyScalar(1+1.3/H.length()),L.lookAt(new THREE.Vector3),L.rotateX(-Math.PI/2),this.latticeParameters.add(L),1===i)continue;if(2===i&&(s!=n||(s+1)%3!=a))continue;let z=new THREE.LineDashedMaterial({color:0,linewidth:2,dashSize:.2,gapSize:.1}),B=(new THREE.Vector3).crossVectors(g,T),W=g.angleTo(T),D=Math.max(Math.min(.25*g.length(),.25*T.length()),1),O=new THREE.EllipseCurve(0,0,D,D,0,W,!1).getSpacedPoints(20),I=(new THREE.Geometry).setFromPoints(O),N=new THREE.Line(I,z);N.computeLineDistances();new THREE.Vector3(0,1,0);let G=new THREE.Vector3(1,0,0),F=(new THREE.Vector3(0,0,1),(new THREE.Quaternion).setFromUnitVectors(G,g.clone().normalize()));N.quaternion.copy(F);let q=I.vertices[I.vertices.length-1];N.updateMatrixWorld();let j=N.localToWorld(q.clone()),k=g,Q=(new THREE.Vector3).crossVectors(k,j),U=B.angleTo(Q);(new THREE.Vector3).crossVectors(T,j).dot(k)>0&&(U=-U),N.rotateX(U),N.updateMatrixWorld(),N.updateMatrix();let Z=N.localToWorld(I.vertices[9].clone()),_=Z.length();Z.multiplyScalar(1+.3/_);let X=o(Z,w.toString(),"#FFFFFF",!0);this.latticeParameters.add(X),this.axisLabels.push(X),this.angleArcs.add(N)}}createBasisVectors(e){let t=[];for(let s=e.length,i=0;i<s;++i){let s=e[i],o=(new THREE.Vector3).fromArray(s);t.push(o)}return t}createCornerPoints(e,t){var s=new THREE.Geometry;s.vertices.push(e);let i=e.clone().add(t[0]).add(t[1]).add(t[2]);s.vertices.push(i);for(let o=t.length,n=0;n<o;++n){let o=e.clone().add(t[n].clone());s.vertices.push(o);let a=i.clone().sub(o);s.vertices.push(a)}this.cornerPoints=new THREE.Points(s),this.cornerPoints.visible=!1,this.vizBasisVectors=t,this.vizOrigin=e,this.root.add(this.cornerPoints)}createConventionalCell(e,t){let s=this.createCell(new THREE.Vector3,this.basisVectors,e,0,1.5,!1);s.visible=t,this.convCell=s,this.root.add(this.convCell)}createPrimitiveCell(e,t){if(null!=this.primitiveVectors){let s=this.createCell(new THREE.Vector3,this.primitiveVectors,e,0,1.5,!0);s.visible=t,this.primCell=s,this.root.add(this.primCell)}}createCell(e,t,s,i,o,n){let a,l=new THREE.Object3D;a=n?new THREE.LineDashedMaterial({color:i,linewidth:o,dashSize:.1,gapSize:.1}):new THREE.LineBasicMaterial({color:i,linewidth:o});let r=new THREE.LineDashedMaterial({color:"#999999",linewidth:o,dashSize:.1,gapSize:.1}),h=!0;for(let e=0;e<3;++e){t[e].length()>.001&&!s[e]&&(h=!1)}for(let i=t.length,o=0;o<i;++o){let n=t[o].clone(),c=a.clone(),d=!s[o];if(!d||!h){d&&(c=r.clone());let t=new THREE.Geometry;t.vertices.push(e.clone(),n.clone().add(e));let s=new THREE.Line(t,c);l.add(s),s.computeLineDistances()}let p=t[(o+1)%i].clone(),m=!s[o]||!s[(o+1)%3];if(!m||!h){let t=a.clone();m&&(t=r.clone());let s=new THREE.Geometry;s.vertices.push(p.clone().add(e),n.clone().add(p).add(e));let i=new THREE.Line(s,t);l.add(i),i.computeLineDistances()}let u=t[(o+2)%i].clone(),E=!s[o]||!s[(o+2)%3];if(!E||!h){let t=a.clone();E&&(t=r.clone());let s=new THREE.Geometry;s.vertices.push(u.clone().add(e),n.clone().add(u).add(e));let i=new THREE.Line(s,t);l.add(i),i.computeLineDistances()}let w=!s[o]||!s[(o+2)%3]||!s[(o+1)%3];if(!w||!h){let t=a.clone();w&&(t=r.clone());let s=new THREE.Geometry;s.vertices.push(p.clone().add(u).add(e),n.clone().add(p).add(u).add(e));let i=new THREE.Line(s,t);l.add(i),i.computeLineDistances()}}return l}setupInitialView1D(e){let t;this.center(),this.root.updateMatrixWorld();for(let s=0;s<e.length;++s){e[s]&&(t=this.basisVectors[s])}let s=new THREE.Vector3(1,0,0),i=(new THREE.Quaternion).setFromUnitVectors(s,t.clone().normalize());i.conjugate(),this.root.quaternion.premultiply(i),this.sceneInfo.quaternion.premultiply(i);let o=new THREE.Vector3(0,1,0),n=new THREE.Vector3(1,0,0);n.applyQuaternion(this.camera.quaternion),o.applyQuaternion(this.camera.quaternion);let a=Math.PI/4;this.rotateAroundWorldAxis(this.root,o,a),this.rotateAroundWorldAxis(this.sceneInfo,o,a);let l=Math.PI/9;this.rotateAroundWorldAxis(this.root,n,l),this.rotateAroundWorldAxis(this.sceneInfo,n,l)}setupInitialView2D(e,t){this.center();let s=this.basisVectors[t[0]].clone(),i=[1,1,1];for(let e=0;e<t.length;++e){i[t[e]]=0}i=(new THREE.Vector3).fromArray(i),this.root.updateMatrixWorld();let o=new THREE.Vector3(0,0,1),n=(new THREE.Quaternion).setFromUnitVectors(i.clone().normalize(),o);this.root.quaternion.premultiply(n),this.sceneInfo.quaternion.premultiply(n),s=s.clone().applyQuaternion(n),i=i.clone().applyQuaternion(n),o=new THREE.Vector3(1,0,0),n=(new THREE.Quaternion).setFromUnitVectors(s.clone().normalize(),o),this.root.quaternion.premultiply(n),this.sceneInfo.quaternion.premultiply(n),this.root.updateMatrixWorld(),this.sceneInfo.updateMatrixWorld();let a=new THREE.Vector3(1,0,0);a.applyQuaternion(this.camera.quaternion);let l=-Math.PI/6;this.rotateAroundWorldAxis(this.root,a,l),this.rotateAroundWorldAxis(this.sceneInfo,a,l)}setupInitialView3D(){this.center();this.basisVectors[0];let e=this.basisVectors[1],t=this.basisVectors[2];this.root.updateMatrixWorld();let s=new THREE.Vector3(0,1,0),i=(new THREE.Quaternion).setFromUnitVectors(t.clone().normalize(),s);this.root.quaternion.premultiply(i),this.sceneInfo.quaternion.premultiply(i),this.root.updateMatrixWorld(),this.sceneInfo.updateMatrixWorld(),e=e.clone().applyQuaternion(i),t=t.clone().applyQuaternion(i);let o=(new THREE.Vector3).crossVectors(e,t),n=new THREE.Vector3(0,0,1),a=(new THREE.Quaternion).setFromUnitVectors(o.clone().normalize(),n);this.root.quaternion.premultiply(a),this.sceneInfo.quaternion.premultiply(a),this.root.updateMatrixWorld(),this.sceneInfo.updateMatrixWorld(),e=e.clone().applyQuaternion(a),t=t.clone().applyQuaternion(a);let l=new THREE.Vector3(0,0,-1);l.applyQuaternion(this.camera.quaternion);let r=(new THREE.Vector3).crossVectors(l,e);r.normalize();let h=-Math.PI/6;this.rotateAroundWorldAxis(this.root,r,h),this.rotateAroundWorldAxis(this.sceneInfo,r,h);let c=(new THREE.Vector3).crossVectors(l,t);c.normalize();let d=Math.PI/12;this.rotateAroundWorldAxis(this.root,c,d),this.rotateAroundWorldAxis(this.sceneInfo,c,d)}center(){let e=(new THREE.Vector3).add(this.vizBasisVectors[0]).add(this.vizBasisVectors[1]).add(this.vizBasisVectors[2]).multiplyScalar(.5),t=this.vizOrigin.clone().add(e).multiplyScalar(-1),s=this.root.children;for(let e=s.length,i=0;i<e;++i){s[i].position.add(t)}let i=this.sceneInfo.children;for(let e=i.length,s=0;s<e;++s){i[s].position.add(t)}}createAtoms(e,t,s){this.elements={},this.atomPos=[],this.atomNumbers=[],this.atomFills=[],this.atomOutlines=[];let i=this.basisVectors[0],o=this.basisVectors[1],n=this.basisVectors[2],a={};for(let l=e.length,r=0;r<l;++r){let l=e[r],h=t[r];this.addAtom(r,l,h,a);let c=this.elementNames[h-1];if(this.elements[c]=[this.elementColors[h],this.elementRadii[h]],s){let e=l.x,t=l.y,s=l.z,c=this.almostEqual(0,e,i,this.wrapTolerance),d=this.almostEqual(0,t,o,this.wrapTolerance),p=this.almostEqual(0,s,n,this.wrapTolerance);c&&d&&p?(this.addAtom(r,new THREE.Vector3(1,0,0),h,a),this.addAtom(r,new THREE.Vector3(0,1,0),h,a),this.addAtom(r,new THREE.Vector3(0,0,1),h,a),this.addAtom(r,new THREE.Vector3(1,1,0),h,a),this.addAtom(r,new THREE.Vector3(0,1,1),h,a),this.addAtom(r,new THREE.Vector3(1,0,1),h,a),this.addAtom(r,new THREE.Vector3(1,1,1),h,a)):c&&d&&!p?(this.addAtom(r,l.clone().add(new THREE.Vector3(1,0,0)),h,a),this.addAtom(r,l.clone().add(new THREE.Vector3(0,1,0)),h,a),this.addAtom(r,l.clone().add(new THREE.Vector3(1,1,0)),h,a)):!c&&d&&p?(this.addAtom(r,l.clone().add(new THREE.Vector3(0,1,0)),h,a),this.addAtom(r,l.clone().add(new THREE.Vector3(0,0,1)),h,a),this.addAtom(r,l.clone().add(new THREE.Vector3(0,1,1)),h,a)):c&&!d&&p?(this.addAtom(r,l.clone().add(new THREE.Vector3(1,0,0)),h,a),this.addAtom(r,l.clone().add(new THREE.Vector3(0,0,1)),h,a),this.addAtom(r,l.clone().add(new THREE.Vector3(1,0,1)),h,a)):!c||d||p?c||!d||p?c||d||!p||this.addAtom(r,l.clone().add(new THREE.Vector3(0,0,1)),h,a):this.addAtom(r,l.clone().add(new THREE.Vector3(0,1,0)),h,a):this.addAtom(r,l.clone().add(new THREE.Vector3(1,0,0)),h,a)}}}createBonds(){let e=this.atomPos.length;this.bondFills=[];for(let t=0;t<e;++t)for(let s=0;s<e;++s)if(s>t){let e=this.atomPos[t],i=this.atomPos[s],o=this.atomNumbers[t],n=this.atomNumbers[s],a=i.clone().sub(e).length(),l=this.options.radiusScale*this.elementRadii[o],r=this.options.radiusScale*this.elementRadii[n];a<=1.1*this.options.bondScale*(l+r)&&this.addBond(t,s,e,i)}}translate(e){let t=(new THREE.Vector3).fromArray(e);this.atoms.position.add(t),this.bonds.position.add(t),this.render()}setZoom(e){this.camera.zoom=e,this.render()}almostEqual(e,t,s,i){let o=t-e;return Math.abs(s.clone().multiplyScalar(o).length())<i}addBond(e,t,s,i){let o=new THREE.MeshPhongMaterial({color:16777215}),n=this.createCylinder(s,i,.075,10,o);n.name="fill",this.bondFills.push(n);let a=new THREE.MeshBasicMaterial({color:0,side:THREE.BackSide}),l=this.createCylinder(s,i,.075*(.02/.075+1),10,a);l.name="outline";let r=new THREE.Group;r.name="bond"+e+"-"+t,r.add(n),r.add(l),this.bonds.add(r)}createAtom(e,t,s,i=!0){if(!(t in s)){let e=this.options.radiusScale*this.elementRadii[t],i=165,o=Math.ceil(360/(180-i)),n=this.elementColors[t],a=new THREE.SphereGeometry(e,o,o),l=new THREE.MeshPhongMaterial({color:n}),r=new THREE.Mesh(a,l),h=.03/e+1,c=new THREE.SphereGeometry(e*h,o,o),d=new THREE.MeshBasicMaterial({color:0,side:THREE.BackSide}),p=new THREE.Mesh(c,d);s[t]={atom:r,outline:p}}let o=s[t],n=new THREE.Vector3;i?(n.add(this.basisVectors[0].clone().multiplyScalar(e.x)),n.add(this.basisVectors[1].clone().multiplyScalar(e.y)),n.add(this.basisVectors[2].clone().multiplyScalar(e.z))):n.copy(e);let a=o.atom.clone();a.position.copy(n);let l=o.outline.clone();return l.position.copy(n),[a,l,n]}addAtom(e,t,s,i,o=!0){let n=this.createAtom(t,s,i,o),a=n[0],l=n[1],r=n[2],h=new THREE.Group;h.name="atom"+e,a.name="fill",l.name="outline",h.add(a),h.add(l),this.atoms.add(h),this.atomFills.push(a),this.atomOutlines.push(l),this.atomPos.push(r),this.atomNumbers.push(s)}render(){let e=this.rootElement,t=e.clientWidth,s=e.clientHeight,i=new THREE.Vector3(1,0,0),o=new THREE.Vector3(0,0,0),n=[i,o];for(let e=0;e<n.length;++e){let i=n[e];this.camera.localToWorld(i),i.project(this.camera),i.x=Math.round((i.x+1)*t/2),i.y=Math.round((1-i.y)*s/2)}let a=(new THREE.Vector3).subVectors(o,i).length(),l=8/Math.pow(a,.5);if(void 0!==this.axisLabels)for(let e=0;e<this.axisLabels.length;++e){this.axisLabels[e].scale.set(l,l,1)}super.render()}setup0D(e,t,s){this.createConventionalCell([!1,!1,!1],this.options.showCell),this.createPrimitiveCell([!1,!1,!1],this.options.showCell),this.createAtoms(e,s,!1),this.createBonds(),this.createCornerPoints(new THREE.Vector3,this.basisVectors),this.createLatticeParameters(this.basisVectors,[!1,!1,!1])}setup1D(e,t,s,i,o){let n=o[0],a=new THREE.Vector3;a.setComponent(n,1);let l=this.basisVectors[n].clone(),r=this.getRepetitions(l,15),h=[],c=[];for(let t=1;t<=r;++t){let i=a.clone().multiplyScalar(t);for(let t=0;t<e.length;++t){let o=(new THREE.Vector3).copy(e[t]);o.add(i);let n=s[t];h.push(o),c.push(n)}let o=a.clone().multiplyScalar(-t);for(let t=0;t<e.length;++t){let i=(new THREE.Vector3).copy(e[t]);i.add(o);let n=s[t];h.push(i),c.push(n)}}e.push.apply(e,h),s.push.apply(s,c),this.options.showCell&&(this.createConventionalCell(i),this.createPrimitiveCell(i)),this.createAtoms(e,s,!1),this.createBonds();let d=[];d.push(this.basisVectors[0].clone()),d.push(this.basisVectors[1].clone()),d.push(this.basisVectors[2].clone()),d[n].multiplyScalar(2*r+1);let p=new THREE.Vector3;p.add(l.multiplyScalar(-r)),this.createCornerPoints(p,d),this.createLatticeParameters(this.basisVectors,i),this.setupInitialView1D(i)}getRepetitions(e,t){let s=e.length();return Math.max(Math.floor(t/s)-1,1)}setup2D(e,t,s,i,o){let n=o[0],a=o[1],l=new THREE.Vector3;l.setComponent(n,1);let r=new THREE.Vector3;r.setComponent(a,1);let h=this.basisVectors[n].clone(),c=this.basisVectors[a].clone(),d=0,p=0;this.options.allowRepeat&&(d=this.getRepetitions(h,12),p=this.getRepetitions(c,12));let m=[],u=[];for(let t=0;t<=d;++t)for(let i=0;i<=p;++i)if(0!=t||0!=i){let o=l.clone().multiplyScalar(t),n=r.clone().multiplyScalar(i);for(let t=0;t<e.length;++t){let i=(new THREE.Vector3).copy(e[t]);i.add(o),i.add(n);let a=s[t];m.push(i),u.push(a)}}e.push.apply(e,m),s.push.apply(s,u),this.createConventionalCell(i,this.options.showCell),this.createPrimitiveCell(i,this.options.showCell),this.createAtoms(e,s,!1),this.createBonds();let E=[];E.push(this.basisVectors[0].clone()),E.push(this.basisVectors[1].clone()),E.push(this.basisVectors[2].clone()),E[n].multiplyScalar(d+1),E[a].multiplyScalar(p+1),this.createCornerPoints(new THREE.Vector3,E),this.createLatticeParameters(this.basisVectors,i,o),this.setupInitialView2D(i,o)}setup3D(e,t,s){this.createConventionalCell([!0,!0,!0],this.options.showCell),this.createPrimitiveCell([!0,!0,!0],this.options.showCell),this.createAtoms(e,s,this.options.showCopies),this.createBonds(),this.createCornerPoints(new THREE.Vector3,this.basisVectors),this.createLatticeParameters(this.basisVectors,[!0,!0,!0]),this.setupInitialView3D()}}let n=document.getElementById("visualizationCanvas");new o(n,{showParam:!0,showCopies:!1,showShadows:!0,showTags:!0,allowRepeat:!1,showCell:!0,wrap:!1,showLegend:!0,showOptions:!0,showUnit:!0,showBonds:!0,radiusScale:.8,bondScale:1.2,enableZoom:!0,enablePan:!0,enableRotate:!0,autoResize:!0,zoomLevel:1}).load({atomicNumbers:[11,17,11,17,11,17,11,17],cell:[[5.6402,0,0],[0,5.6402,0],[0,0,5.6402]],scaledPositions:[[0,.5,0],[0,.5,.5],[0,0,.5],[0,0,0],[.5,.5,.5],[.5,.5,0],[.5,0,0],[.5,0,.5]],primitiveCell:[[0,2.8201,2.8201],[2.8201,0,2.8201],[2.8201,2.8201,0]],pbc:[!0,!0,!0]})}]);