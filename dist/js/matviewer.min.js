var matviewer=function(e){var t={};function i(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,i),o.l=!0,o.exports}return i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)i.d(s,o,function(t){return e[t]}.bind(null,o));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=0)}([function(e,t,i){e.exports=i(1)},function(e,t,i){"use strict";i.r(t),i.d(t,"StructureViewer",(function(){return o})),i.d(t,"BrillouinZoneViewer",(function(){return n}));class s{constructor(e,t={},i=!1){this.hostElement=e,this.saveBuffer=i,this.scenes=[],this.cameraWidth=10,this.options={},this.handleSettings(t),this.setupRootElement(),this.setupRenderer(),this.setupScenes(),this.setupStatic(),this.setupCamera(),this.setupControls(),this.setupHostElement(e),this.options.view.autoResize&&window.addEventListener("resize",this.onWindowResize.bind(this),!1)}handleSettings(e){let t={controls:{enableZoom:!0,enableRotate:!0,enablePan:!0,panSpeed:10,zoomSpeed:2.5,rotateSpeed:2.5,zoomLevel:1},view:{autoFit:!0,autoResize:!0,fitMargin:.5},font:{family:"Arial"}};this.fillOptions(e,t),this.options=t}fillOptions(e,t){!function e(t,i,s){for(var o in t)"object"==typeof t[o]&&null!==t[o]?(void 0===i[o]&&(i[o]={}),e(t[o],i[o])):i[o]=t[o]}(e,t)}load(e){this.clear(),this.setupScenes(),this.setupLights(),this.setupCamera(),this.setupControls();let t=this.setupVisualization(e);return this.options.view.autoFit&&this.fitToCanvas(),this.render(),this.animate(),t}loadJSON(e){var t=new XMLHttpRequest;t.onreadystatechange=()=>{this.load(JSON.parse(t.responseText))},t.open("GET",e,!0),t.send()}setupStatic(){}setupScenes(){this.scenes=[],this.scene=new THREE.Scene,this.scenes.push(this.scene)}clear(){this.clearScenes(),this.scenes=null,this.controls=null,this.camera=null,this.cornerPoints=null}clearScenes(){for(let e=0;e<this.scenes.length;++e){let t=this.scenes[e];for(t.traverse((function(e){let t=e.geometry,i=e.material,s=e.texture;t&&t.dispose(),i&&i.dispose(),s&&s.dispose()}));t.children.length;){let e=t.children[0];t.remove(e)}}}takeScreenShot(e){let t;try{let i="image/jpeg",s="image/octet-stream";t=this.renderer.domElement.toDataURL(i);let o=t.replace(i,s);e+=".jpg";let n=document.createElement("a");"string"==typeof n.download?(document.body.appendChild(n),n.download=e,n.href=o,n.click(),document.body.removeChild(n)):location.replace(uri)}catch(e){return void console.log(e)}}webglAvailable(){try{let e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}setupRenderer(){this.webglAvailable()?this.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0,preserveDrawingBuffer:this.saveBuffer}):console.log("WebGL is not supported on this browser, cannot display structure."),this.renderer.shadowMap.enabled=!1,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,this.renderer.setSize(this.rootElement.clientWidth,this.rootElement.clientHeight),this.renderer.setClearColor(16777215,0),this.rootElement.appendChild(this.renderer.domElement),this.renderer.autoClear=!1}setupCamera(){let e=this.rootElement.clientWidth/this.rootElement.clientHeight,t=this.cameraWidth,i=t/e;this.camera=new THREE.OrthographicCamera(t/-2,t/2,i/2,i/-2,-100,1e3),this.camera.name="camera",this.camera.position.z=20}setupRootElement(){this.rootElement=document.createElement("div"),this.rootElement.style.width="100%",this.rootElement.style.height="100%",this.rootElement.style.position="relative"}setupHostElement(e){if(this.hostElement)for(;this.hostElement.firstChild;)this.hostElement.removeChild(this.hostElement.firstChild);e.appendChild(this.rootElement),this.resizeCanvasToHostElement()}changeHostElement(e){this.setupHostElement(e),this.options.view.autoFit&&this.fitToCanvas(),this.render()}setupControls(){let e=new THREE.OrthographicControls(this.camera,this.rootElement);e.rotateSpeed=this.options.controls.rotateSpeed,e.rotationCenter=new THREE.Vector3,e.zoomSpeed=this.options.controls.zoomSpeed,e.panSpeed=this.options.controls.panSpeed,e.enableZoom=this.options.controls.enableZoom,e.enablePan=this.options.controls.enablePan,e.enableRotate=this.options.controls.enableRotate,e.staticMoving=!0,e.dynamicDampingFactor=.25,e.keys=[65,83,68],e.addEventListener("change",this.render.bind(this)),this.controls=e}createCornerPoints(e,t){var i=new THREE.Geometry;i.vertices.push(e);let s=e.clone().add(t[0]).add(t[1]).add(t[2]);i.vertices.push(s);for(let o=t.length,n=0;n<o;++n){let o=e.clone().add(t[n].clone());i.vertices.push(o);let r=s.clone().sub(t[n].clone());i.vertices.push(r)}return i}fitToCanvas(){this.scenes.forEach(e=>e.updateMatrixWorld());let e=this.rootElement,t=e.clientWidth,i=e.clientHeight,s=[],o=new THREE.Vector3;for(let e=this.cornerPoints.geometry.vertices.length,t=0;t<e;++t){let e=this.cornerPoints.geometry.vertices[t].clone();this.cornerPoints.localToWorld(e),o.add(e)}for(let e=this.cornerPoints.geometry.vertices.length,n=0;n<e;++n){let e=this.cornerPoints.geometry.vertices[n].clone();this.cornerPoints.localToWorld(e);this.camera.zoom;this.camera.zoom=this.options.controls.zoomLevel,this.camera.updateProjectionMatrix();let r=o.sub(e);r.project(this.camera);let l=r.x<0,a=r.y<0;e.project(this.camera);let h=this.options.view.fitMargin,c=new THREE.Vector3(0,h,0),d=new THREE.Vector3(h,0,0);c.applyQuaternion(this.camera.quaternion),d.applyQuaternion(this.camera.quaternion),a?e.add(c):e.sub(c),l?e.add(d):e.sub(d),e.x=Math.round((e.x+1)*t/2),e.y=Math.round((1-e.y)*i/2),e.z=0,s.push(e)}let n=s[0].x,r=s[0].x,l=s[0].y,a=s[0].y;for(let e=s.length,t=0;t<e;++t){let e=s[t],i=e.x,o=e.y;i>r?r=i:i<n&&(n=i),o>a?a=o:o<l&&(l=o)}let h,c=t/(r-n),d=i/(a-l);c<=1&&d<=1||c>=1&&d>=1?h=Math.min(c,d):c<=1&&d>=1?h=c:d<=1&&c>=1&&(h=d),this.camera.zoom=h,this.camera.updateProjectionMatrix()}getZoom(){return this.camera.zoom}setZoom(e){this.camera.zoom=e,this.camera.updateProjectionMatrix()}resizeCanvasToHostElement(){let e=this.rootElement.clientWidth/this.rootElement.clientHeight,t=this.cameraWidth,i=t/e;this.camera.left=-t/2,this.camera.right=t/2,this.camera.top=i/2,this.camera.bottom=-i/2,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.rootElement.clientWidth,this.rootElement.clientHeight),this.controls.handleResize(),this.render()}onWindowResize(){this.resizeCanvasToHostElement(),this.options.view.autoFit&&this.fitToCanvas(),this.render()}render(){this.renderer.clear();for(let e=0;e<this.scenes.length;++e){let t=this.scenes[e];this.renderer.render(t,this.camera),e!==this.scenes.length-1&&this.renderer.clearDepth()}}animate(){requestAnimationFrame(this.animate.bind(this)),this.controls.update()}createCylinder(e,t,i,s,o){var n=(new THREE.Vector3).subVectors(t,e);let r=n.length(),l=n.clone().divideScalar(r);var a=new THREE.ArrowHelper(l,e),h=new THREE.CylinderGeometry(i,i,r,s,0),c=new THREE.Mesh(h,o);return c.rotation.copy(a.rotation.clone()),c.position.copy((new THREE.Vector3).addVectors(e,n.multiplyScalar(.5))),c}rotateAroundWorldAxis(e,t,i){let s=new THREE.Matrix4;s.makeRotationAxis(t.normalize(),i),s.multiply(e.matrix),e.matrix=s,e.rotation.setFromRotationMatrix(e.matrix)}}class o extends s{constructor(){super(...arguments),this.axisLabels=[],this.wrapTolerance=.05,this.tagColorMap={adsorbates:"0xd70000",unknowns:"0xd75f00",interstitials:"0xaf8700",substitutions:"0x0087ff",outliers:"0x0087ff"},this.elementNames=["H","He","Li","Be","B","C","N","O","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Ge","As","Se","Br","Kr","Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I","Xe","Cs","Ba","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","At","Rn","Fr","Ra","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr","Rf","Ha","Sg","Ns","Hs","Mt","Ds","Rg","Cn","Nh","Fl","Mc","Lv","Ts","Og"],this.elementNumbers={H:1,He:2,Li:3,Be:4,B:5,C:6,N:7,O:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,S:16,Cl:17,Ar:18,K:19,Ca:20,Sc:21,Ti:22,V:23,Cr:24,Mn:25,Fe:26,Co:27,Ni:28,Cu:29,Zn:30,Ga:31,Ge:32,As:33,Se:34,Br:35,Kr:36,Rb:37,Sr:38,Y:39,Zr:40,Nb:41,Mo:42,Tc:43,Ru:44,Rh:45,Pd:46,Ag:47,Cd:48,In:49,Sn:50,Sb:51,Te:52,I:53,Xe:54,Cs:55,Ba:56,La:57,Ce:58,Pr:59,Nd:60,Pm:61,Sm:62,Eu:63,Gd:64,Tb:65,Dy:66,Ho:67,Er:68,Tm:69,Yb:70,Lu:71,Hf:72,Ta:73,W:74,Re:75,Os:76,Ir:77,Pt:78,Au:79,Hg:80,Tl:81,Pb:82,Bi:83,Po:84,At:85,Rn:86,Fr:87,Ra:88,Ac:89,Th:90,Pa:91,U:92,Np:93,Pu:94,Am:95,Cm:96,Bk:97,Cf:98,Es:99,Fm:100,Md:101,No:102,Lr:103},this.missing=.2,this.elementRadii=[this.missing,.31,.28,1.28,.96,.84,.76,.71,.66,.57,.58,1.66,1.41,1.21,1.11,1.07,1.05,1.02,1.06,2.03,1.76,1.7,1.6,1.53,1.39,1.39,1.32,1.26,1.24,1.32,1.22,1.22,1.2,1.19,1.2,1.2,1.16,2.2,1.95,1.9,1.75,1.64,1.54,1.47,1.46,1.42,1.39,1.45,1.44,1.42,1.39,1.39,1.38,1.39,1.4,2.44,2.15,2.07,2.04,2.03,2.01,1.99,1.98,1.98,1.96,1.94,1.92,1.92,1.89,1.9,1.87,1.87,1.75,1.7,1.62,1.51,1.44,1.41,1.36,1.36,1.32,1.45,1.46,1.48,1.4,1.5,1.5,2.6,2.21,2.15,2.06,2,1.96,1.9,1.87,1.8,1.69,this.missing,this.missing,this.missing,this.missing,this.missing,this.missing,this.missing],this.elementColors=[16711680,16777215,14286847,13402367,12779264,16758197,9474192,3166456,16715021,9494608,11789301,11230450,9109248,12560038,1578e4,16744448,16777008,2093087,8442339,9388244,4062976,15132390,12567239,10921643,9083335,10255047,14706227,15765664,5296208,13140019,8224944,12750735,6721423,12419299,16752896,10889513,6076625,7351984,65280,9764863,9756896,7586505,5551541,3907230,2396047,687500,27013,12632256,16767375,10909043,6717568,10380213,13924864,9699476,4366e3,5707663,51456,7394559,16777159,14286791,13107143,10747847,9437127,6422471,4587463,3211207,2097095,65436,58997,54354,48952,43812,5096191,5089023,2200790,2522539,2516630,1528967,13684960,16765219,12105936,10900557,5724513,10375093,11230208,7688005,4358806,4325478,32e3,7384058,47871,41471,36863,33023,27647,5528818,7888099,9064419,10565332,11739092,11739066,11734438,12389767,13041766,13369433,13697103,14221381,14680120,15073326,15400998]}setupScenes(){this.scenes=[],this.sceneStructure=new THREE.Scene,this.scenes.push(this.sceneStructure),this.sceneInfo=new THREE.Scene,this.scenes.push(this.sceneInfo)}handleSettings(e){let t={view:{fitMargin:.5},structure:{showParam:!0,createLegend:!0,showLegend:!0,showBonds:!0,allowRepeat:!0,showCopies:!1,showCell:!0,wrap:!0,radiusScale:1,bondScale:1,translation:[0,0,0],viewCenter:"COP",showShadows:!1}};this.fillOptions(e,t),super.handleSettings(t)}setupVisualization(e){e.primitiveCell;let t=e.cell,i=e.scaledPositions,s=e.positions,o=e.atomicNumbers,n=e.chemicalSymbols,r=e.pbc,l=e.bonds;if(this.tags=e.tags,!i&&!s)return console.log("No atom positions given to the structure viewer"),!1;if(!o&&!n)return console.log("No atomicNumbers or chemicalSymbols given to the structure viewer."),!1;if(o||(o=n.map(e=>this.elementNumbers[e])),l){if("off"!=l&&"auto"!=l&&!Array.isArray(l))return console.log("Invalid value for 'bonds'. Use either 'auto', 'off' or provide a list of index pairs. If not defined, 'auto' is assumed."),!1}else;if(s&&s.length!=o.length)return console.log("The number of positions does not match the number of labels."),!1;if(i&&i.length!=o.length)return console.log("The number of scaled positions does not match the number of labels."),!1;null!=r&&null!=r||(r=[!0,!0,!0]),this.root=new THREE.Object3D,this.atoms=new THREE.Object3D,this.bonds=new THREE.Object3D,this.cellVectorLines=new THREE.Object3D,this.angleArcs=new THREE.Object3D,this.root.add(this.cellVectorLines),this.root.add(this.atoms),this.root.add(this.bonds),this.sceneStructure.add(this.root),this.basisVectors=this.createBasisVectors(t);let a=[],h=[];if(void 0!==i)for(let e=0;e<i.length;++e){let t=i[e],s=(new THREE.Vector3).fromArray(t),o=s.x,n=s.y,l=s.z;this.options.structure.wrap&&(r[0]&&this.almostEqual(1,o,this.basisVectors[0],this.wrapTolerance)&&(o-=1),r[1]&&this.almostEqual(1,n,this.basisVectors[1],this.wrapTolerance)&&(n-=1),r[2]&&this.almostEqual(1,l,this.basisVectors[2],this.wrapTolerance)&&(l-=1)),s=new THREE.Vector3(o,n,l),a.push(s);let c=new THREE.Vector3;c.add(this.basisVectors[0].clone().multiplyScalar(s.x)),c.add(this.basisVectors[1].clone().multiplyScalar(s.y)),c.add(this.basisVectors[2].clone().multiplyScalar(s.z)),h.push(c)}else if(void 0!==s)for(let e=0;e<s.length;++e){let i=s[e],o=(new THREE.Vector3).fromArray(i);h.push(o);let n=new THREE.Matrix3;n.set(t[0][0],t[0][1],t[0][2],t[1][0],t[1][1],t[1][2],t[2][0],t[2][1],t[2][2]);let r=(new THREE.Matrix3).getInverse(n),l=o.clone().applyMatrix3(r);a.push(l)}let c=0,d=[],u=r[0],p=r[1],E=r[2];if(u&&p&&E)c=3;else if(u||p||E)for(let e=0;e<3;++e){let t=r[e],i=r[(e+1)%3],s=r[(e+2)%3];if(t&&!i&&!s){c=1,d.push(e);break}if(t&&i&&!s){c=2,d.push(e),d.push((e+1)%3);break}}else c=0;0===c&&this.setup0D(a,h,o),1===c?this.setup1D(a,h,o,r,d):2===c?this.setup2D(a,h,o,r,d):3===c&&this.setup3D(a,h,o),this.createVisualizationBoundaryPositions(this.atomPos,o),this.createBonds(l);let m,w=this.options.structure.viewCenter;return"COP"===w?m=this.calculateCOP(this.atomPos):"COC"===w?m=(new THREE.Vector3).add(this.basisVectors[0]).add(this.basisVectors[1]).add(this.basisVectors[2]).multiplyScalar(.5):Array.isArray(w)&&(m=(new THREE.Vector3).fromArray(w)),this.setViewCenter(m),this.translate(this.options.structure.translation),this.setZoom(this.options.controls.zoomLevel),this.options.structure.createLegend&&this.createElementLegend(),!0}calculateCOP(e){let t=e.length,i=new THREE.Vector3;for(let s=0;s<t;++s){let t=e[s];i.add(t)}return i.divideScalar(t),i}setViewCenter(e){this.cornerPoints.position.sub(e),this.atoms.position.sub(e),this.bonds.position.sub(e),this.latticeParameters.position.sub(e),this.angleArcs.position.sub(e),this.convCell.position.sub(e),this.render()}translate(e){let t=(new THREE.Vector3).fromArray(e);this.atoms.position.add(t),this.bonds.position.add(t),this.render()}setZoom(e){this.camera.zoom=e,this.render()}setupStatic(){if(this.options.structure.createLegend){var e=document.createElement("div");e.id="elementlegend",this.elementLegend=e,this.rootElement.appendChild(e)}}setupLights(){this.lights=[];let e=new THREE.DirectionalLight(16777215,.45);e.shadowMapWidth=2048,e.shadowMapHeight=2048,e.position.set(0,0,20),this.sceneStructure.add(e),this.lights.push(e);let t=new THREE.DirectionalLight(16777215,.3);t.shadowMapWidth=2048,t.shadowMapHeight=2048,t.position.set(-20,0,-20),this.sceneStructure.add(t),this.lights.push(t);let i=new THREE.DirectionalLight(16777215,.25);i.shadowMapWidth=2048,i.shadowMapHeight=2048,i.position.set(20,0,-20),this.sceneStructure.add(i),this.lights.push(i);let s=new THREE.AmbientLight(4210752,1.7);this.sceneStructure.add(s)}toggleElementLegend(e){this.elementLegend.style.display=e?"flex":"None"}toggleLatticeParameters(e){this.latticeParameters.visible=e,this.cellVectorLines.visible=e,this.angleArcs.visible=e,this.render()}toggleCell(e){void 0!==this.convCell&&(this.convCell.visible=e),void 0!==this.primCell&&(this.primCell.visible=e),this.render()}toggleBonds(e){this.bonds.visible=e,this.render()}toggleShadows(e){this.renderer.shadowMapEnabled=e;for(let t=0;t<this.lights.length;++t){this.lights[t].castShadow=e}for(let t=0;t<this.atomFills.length;++t){let i=this.atomFills[t];i.receiveShadow=e,i.castShadow=e,i.material.needsUpdate=!0}for(let t=0;t<this.bondFills.length;++t){let i=this.bondFills[t];i.receiveShadow=e,i.castShadow=e,i.material.needsUpdate=!0}this.render(),this.render()}createElementLegend(){for(;this.elementLegend.firstChild;)this.elementLegend.removeChild(this.elementLegend.firstChild);let e=[];for(let t in this.elements)this.elements.hasOwnProperty(t)&&e.push([t,this.elements[t][0],this.elements[t][1]]);e.sort((function(e,t){let i=e[0],s=t[0];return i<s?-1:i>s?1:0}));for(let t=0;t<e.length;++t){let i=e[t][0],s=e[t][1].toString(16),o=6-s.length;s="#"+Array(o+1).join("0")+s;let n=50*e[t][2],r=document.createElement("div");r.className="elementlabel",r.style.backgroundColor=s,r.style.height=n+"px",r.style.width=n+"px",r.style.textAlign="center",r.style.verticalAlign="middle",r.style.lineHeight=n+"px",r.style.borderRadius=n/2+"px",r.textContent=i,this.elementLegend.appendChild(r)}}createLatticeParameters(e,t,i){this.latticeParameters=new THREE.Object3D,this.axisLabels=[],this.sceneInfo.add(this.latticeParameters),this.sceneInfo.add(this.angleArcs);let s=0;for(let e=0;e<t.length;++e)t[e]&&++s;let o,n,r=(e,t,i,s=!0)=>{let o=document.createElement("canvas");o.width=256,o.height=256;let n=o.getContext("2d");n.fillStyle=i,n.font="155px "+this.options.font.family,n.textAlign="center",s&&(n.font="160px "+this.options.font.family,n.lineWidth=8,n.strokeStyle="#000000",n.strokeText(t,128,128)),n.fillText(t,128,128);let r=new THREE.Texture(o);r.needsUpdate=!0;let l=new THREE.SpriteMaterial({map:r}),a=new THREE.Sprite(l);a.position.copy(e);return a.scale.set(1.5,1.5,1),a},l=(new THREE.LineBasicMaterial({color:"#000000",linewidth:1.5}),["#C52929","#47A823","#3B5796"]),a=-1,h=["a","b","c"],c=["γ","α","β"];2===s&&(o=i[0],n=i[1]);for(let i=0;i<3;++i){if(!t[i])continue;a+=1;let d,u,p,E=h[a],m=l[a],w=c[a],T=e[i],f=e[(i+1)%3].clone(),R=e[(i+2)%3].clone(),g=new THREE.Vector3(0,0,0),H=T.clone(),y=H.clone().multiplyScalar(.5);if(0==f.length())u=(new THREE.Vector3).crossVectors(T,R),d=(new THREE.Vector3).crossVectors(T,u);else if(0==R.length())p=(new THREE.Vector3).crossVectors(T,f),d=(new THREE.Vector3).crossVectors(T,R);else{let e=(new THREE.Vector3).crossVectors(T,f),t=(new THREE.Vector3).crossVectors(T,R);d=(new THREE.Vector3).sub(e).add(t)}if(d.normalize(),d.multiplyScalar(.8),y.add(d),3===s)E=r(y,E,m),this.latticeParameters.add(E),this.axisLabels.push(E);else if(2===s){let e=r(y,E,m);this.latticeParameters.add(e),this.axisLabels.push(e),w="γ"}else{let e=r(y,"a",m);this.latticeParameters.add(e),this.axisLabels.push(e)}let b=new THREE.MeshBasicMaterial({color:m,transparent:!0,opacity:.75}),V=T.clone(),S=this.createCylinder(g.clone(),V.clone().add(g),.09,10,b);this.latticeParameters.add(S);let C=new THREE.MeshBasicMaterial({color:"#000000"}),v=this.basisVectors[i].clone(),P=v.clone().multiplyScalar(1+1.3/v.length()),M=(T.clone(),this.createCylinder(g.clone(),P,.02,10,C));this.latticeParameters.add(M);let x=new THREE.CylinderGeometry(0,.1,.5,12),A=new THREE.MeshBasicMaterial({color:0}),L=new THREE.Mesh(x,A);if(L.position.copy(H).multiplyScalar(1+1.3/H.length()),L.lookAt(new THREE.Vector3),L.rotateX(-Math.PI/2),this.latticeParameters.add(L),1===s)continue;if(2===s&&(i!=o||(i+1)%3!=n))continue;let z=new THREE.LineDashedMaterial({color:0,linewidth:2,dashSize:.2,gapSize:.1}),W=(new THREE.Vector3).crossVectors(T,f),I=T.angleTo(f),B=Math.max(Math.min(1/4*T.length(),1/4*f.length()),1),D=new THREE.EllipseCurve(0,0,B,B,0,I,!1).getSpacedPoints(20),F=(new THREE.Geometry).setFromPoints(D),O=new THREE.Line(F,z);O.computeLineDistances();new THREE.Vector3(0,1,0);let N=new THREE.Vector3(1,0,0),q=(new THREE.Vector3(0,0,1),(new THREE.Quaternion).setFromUnitVectors(N,T.clone().normalize()));O.quaternion.copy(q);let j=F.vertices[F.vertices.length-1];O.updateMatrixWorld();let G=O.localToWorld(j.clone()),Z=T,Q=(new THREE.Vector3).crossVectors(Z,G),k=W.angleTo(Q);(new THREE.Vector3).crossVectors(f,G).dot(Z)>0&&(k=-k),O.rotateX(k),O.updateMatrixWorld(),O.updateMatrix();let U=O.localToWorld(F.vertices[9].clone()),X=U.length();U.multiplyScalar(1+.3/X);let _=r(U,w.toString(),"#FFFFFF",!0);this.latticeParameters.add(_),this.axisLabels.push(_),this.angleArcs.add(O)}}createBasisVectors(e){let t=[];for(let i=e.length,s=0;s<i;++s){let i=e[s],o=(new THREE.Vector3).fromArray(i);t.push(o)}return t}createVisualizationBoundaryPositions(e,t){let i=-1/0,s=-1/0,o=-1/0,n=1/0,r=1/0,l=1/0,a=0;for(let h=e.length,c=0;c<h;++c){let h=e[c],d=h.x;d>i&&(i=d),d<n&&(n=d);let u=h.y;u>s&&(s=u),u<r&&(r=u);let p=h.z;p>o&&(o=p),p<l&&(l=p);let E=this.elementRadii[t[c]];E>a&&(a=E)}let h=new THREE.Vector3(n-a,r-a,l-a),c=[new THREE.Vector3(i-n+2*a,0,0),new THREE.Vector3(0,s-r+2*a,0),new THREE.Vector3(0,0,o-l+2*a)],d=this.createCornerPoints(h,c),u=new THREE.Points(d);u.visible=!1,this.cornerPoints=u,this.root.add(this.cornerPoints)}createVisualizationBoundaryCell(e,t){let i=this.createCornerPoints(e,t),s=new THREE.Points(i);s.visible=!1,this.cornerPoints=s,this.root.add(this.cornerPoints)}createConventionalCell(e,t){let i=this.createCell(new THREE.Vector3,this.basisVectors,e,0,1.5,!1);i.visible=t,this.convCell=i,this.root.add(this.convCell)}createPrimitiveCell(e,t){if(null!=this.primitiveVectors){let i=this.createCell(new THREE.Vector3,this.primitiveVectors,e,0,1.5,!0);i.visible=t,this.primCell=i,this.root.add(this.primCell)}}createCell(e,t,i,s,o,n){let r,l=new THREE.Object3D;r=n?new THREE.LineDashedMaterial({color:s,linewidth:o,dashSize:.1,gapSize:.1}):new THREE.LineBasicMaterial({color:s,linewidth:o});let a=new THREE.LineDashedMaterial({color:"#999999",linewidth:o,dashSize:.1,gapSize:.1}),h=!0;for(let e=0;e<3;++e){t[e].length()>.001&&!i[e]&&(h=!1)}for(let s=t.length,o=0;o<s;++o){let n=t[o].clone(),c=r.clone(),d=!i[o];if(!d||!h){d&&(c=a.clone());let t=new THREE.Geometry;t.vertices.push(e.clone(),n.clone().add(e));let i=new THREE.Line(t,c);l.add(i),i.computeLineDistances()}let u=t[(o+1)%s].clone(),p=!i[o]||!i[(o+1)%3];if(!p||!h){let t=r.clone();p&&(t=a.clone());let i=new THREE.Geometry;i.vertices.push(u.clone().add(e),n.clone().add(u).add(e));let s=new THREE.Line(i,t);l.add(s),s.computeLineDistances()}let E=t[(o+2)%s].clone(),m=!i[o]||!i[(o+2)%3];if(!m||!h){let t=r.clone();m&&(t=a.clone());let i=new THREE.Geometry;i.vertices.push(E.clone().add(e),n.clone().add(E).add(e));let s=new THREE.Line(i,t);l.add(s),s.computeLineDistances()}let w=!i[o]||!i[(o+2)%3]||!i[(o+1)%3];if(!w||!h){let t=r.clone();w&&(t=a.clone());let i=new THREE.Geometry;i.vertices.push(u.clone().add(E).add(e),n.clone().add(u).add(E).add(e));let s=new THREE.Line(i,t);l.add(s),s.computeLineDistances()}}return l}setupInitialView1D(e){let t;this.root.updateMatrixWorld();for(let i=0;i<e.length;++i){e[i]&&(t=this.basisVectors[i])}let i=new THREE.Vector3(1,0,0),s=(new THREE.Quaternion).setFromUnitVectors(i,t.clone().normalize());s.conjugate(),this.root.quaternion.premultiply(s),this.sceneInfo.quaternion.premultiply(s);let o=new THREE.Vector3(0,1,0),n=new THREE.Vector3(1,0,0);n.applyQuaternion(this.camera.quaternion),o.applyQuaternion(this.camera.quaternion);let r=Math.PI/4;this.rotateAroundWorldAxis(this.root,o,r),this.rotateAroundWorldAxis(this.sceneInfo,o,r);let l=Math.PI/9;this.rotateAroundWorldAxis(this.root,n,l),this.rotateAroundWorldAxis(this.sceneInfo,n,l)}setupInitialView2D(e,t){let i=this.basisVectors[t[0]].clone(),s=[1,1,1];for(let e=0;e<t.length;++e){s[t[e]]=0}s=(new THREE.Vector3).fromArray(s),this.root.updateMatrixWorld();let o=new THREE.Vector3(0,0,1),n=(new THREE.Quaternion).setFromUnitVectors(s.clone().normalize(),o);this.root.quaternion.premultiply(n),this.sceneInfo.quaternion.premultiply(n),i=i.clone().applyQuaternion(n),s=s.clone().applyQuaternion(n),o=new THREE.Vector3(1,0,0),n=(new THREE.Quaternion).setFromUnitVectors(i.clone().normalize(),o),this.root.quaternion.premultiply(n),this.sceneInfo.quaternion.premultiply(n),this.root.updateMatrixWorld(),this.sceneInfo.updateMatrixWorld();let r=new THREE.Vector3(1,0,0);r.applyQuaternion(this.camera.quaternion);let l=-Math.PI/6;this.rotateAroundWorldAxis(this.root,r,l),this.rotateAroundWorldAxis(this.sceneInfo,r,l)}setupInitialView3D(){this.basisVectors[0];let e=this.basisVectors[1],t=this.basisVectors[2];this.root.updateMatrixWorld();let i=new THREE.Vector3(0,1,0),s=(new THREE.Quaternion).setFromUnitVectors(t.clone().normalize(),i);this.root.quaternion.premultiply(s),this.sceneInfo.quaternion.premultiply(s),this.root.updateMatrixWorld(),this.sceneInfo.updateMatrixWorld(),e=e.clone().applyQuaternion(s),t=t.clone().applyQuaternion(s);let o=(new THREE.Vector3).crossVectors(e,t),n=new THREE.Vector3(0,0,1),r=(new THREE.Quaternion).setFromUnitVectors(o.clone().normalize(),n);this.root.quaternion.premultiply(r),this.sceneInfo.quaternion.premultiply(r),this.root.updateMatrixWorld(),this.sceneInfo.updateMatrixWorld(),e=e.clone().applyQuaternion(r),t=t.clone().applyQuaternion(r);let l=new THREE.Vector3(0,0,-1);l.applyQuaternion(this.camera.quaternion);let a=(new THREE.Vector3).crossVectors(l,e);a.normalize();let h=-Math.PI/3;this.rotateAroundWorldAxis(this.root,a,h),this.rotateAroundWorldAxis(this.sceneInfo,a,h);let c=(new THREE.Vector3).crossVectors(l,t);c.normalize();let d=Math.PI/6;this.rotateAroundWorldAxis(this.root,c,d),this.rotateAroundWorldAxis(this.sceneInfo,c,d)}createAtoms(e,t,i){this.elements={},this.atomPos=[],this.atomNumbers=[],this.atomFills=[],this.atomOutlines=[];let s=this.basisVectors[0],o=this.basisVectors[1],n=this.basisVectors[2],r={};for(let l=e.length,a=0;a<l;++a){let l=e[a],h=t[a];this.addAtom(a,l,h,r);let c=this.elementNames[h-1];if(this.elements[c]=[this.elementColors[h],this.elementRadii[h]],i){let e=l.x,t=l.y,i=l.z,c=this.almostEqual(0,e,s,this.wrapTolerance),d=this.almostEqual(0,t,o,this.wrapTolerance),u=this.almostEqual(0,i,n,this.wrapTolerance);c&&d&&u?(this.addAtom(a,new THREE.Vector3(1,0,0),h,r),this.addAtom(a,new THREE.Vector3(0,1,0),h,r),this.addAtom(a,new THREE.Vector3(0,0,1),h,r),this.addAtom(a,new THREE.Vector3(1,1,0),h,r),this.addAtom(a,new THREE.Vector3(0,1,1),h,r),this.addAtom(a,new THREE.Vector3(1,0,1),h,r),this.addAtom(a,new THREE.Vector3(1,1,1),h,r)):c&&d&&!u?(this.addAtom(a,l.clone().add(new THREE.Vector3(1,0,0)),h,r),this.addAtom(a,l.clone().add(new THREE.Vector3(0,1,0)),h,r),this.addAtom(a,l.clone().add(new THREE.Vector3(1,1,0)),h,r)):!c&&d&&u?(this.addAtom(a,l.clone().add(new THREE.Vector3(0,1,0)),h,r),this.addAtom(a,l.clone().add(new THREE.Vector3(0,0,1)),h,r),this.addAtom(a,l.clone().add(new THREE.Vector3(0,1,1)),h,r)):c&&!d&&u?(this.addAtom(a,l.clone().add(new THREE.Vector3(1,0,0)),h,r),this.addAtom(a,l.clone().add(new THREE.Vector3(0,0,1)),h,r),this.addAtom(a,l.clone().add(new THREE.Vector3(1,0,1)),h,r)):!c||d||u?c||!d||u?c||d||!u||this.addAtom(a,l.clone().add(new THREE.Vector3(0,0,1)),h,r):this.addAtom(a,l.clone().add(new THREE.Vector3(0,1,0)),h,r):this.addAtom(a,l.clone().add(new THREE.Vector3(1,0,0)),h,r)}}}createBonds(e="auto"){if(this.bondFills=[],Array.isArray(e))for(let t of e){let e=t[0],i=t[1],s=this.atomPos[e],o=this.atomPos[i];console.log(e,i,s,o),this.addBond(e,i,s,o)}else if("auto"===e){let e=this.atomPos.length;for(let t=0;t<e;++t)for(let i=0;i<e;++i)if(i>t){let e=this.atomPos[t],s=this.atomPos[i],o=this.atomNumbers[t],n=this.atomNumbers[i],r=s.clone().sub(e).length(),l=this.options.structure.radiusScale*this.elementRadii[o],a=this.options.structure.radiusScale*this.elementRadii[n];r<=1.1*this.options.structure.bondScale*(l+a)&&this.addBond(t,i,e,s)}}}almostEqual(e,t,i,s){let o=t-e;return Math.abs(i.clone().multiplyScalar(o).length())<s}addBond(e,t,i,s){let o=new THREE.MeshPhongMaterial({color:16777215,shininess:30}),n=this.createCylinder(i,s,.08,10,o);n.name="fill",this.bondFills.push(n);let r=new THREE.MeshBasicMaterial({color:0,side:THREE.BackSide}),l=this.createCylinder(i,s,.1,10,r);l.name="outline";let a=new THREE.Group;a.name="bond"+e+"-"+t,a.add(n),a.add(l),this.bonds.add(a)}createAtom(e,t,i,s=!0){if(!(t in i)){let e=this.options.structure.radiusScale*this.elementRadii[t],s=165,o=Math.ceil(360/(180-s)),n=this.elementColors[t],r=new THREE.SphereGeometry(e,o,o),l=new THREE.MeshPhongMaterial({color:n,shininess:30}),a=new THREE.Mesh(r,l),h=.03/e+1,c=new THREE.SphereGeometry(e*h,o,o),d=new THREE.MeshBasicMaterial({color:0,side:THREE.BackSide}),u=new THREE.Mesh(c,d);i[t]={atom:a,outline:u}}let o=i[t],n=new THREE.Vector3;s?(n.add(this.basisVectors[0].clone().multiplyScalar(e.x)),n.add(this.basisVectors[1].clone().multiplyScalar(e.y)),n.add(this.basisVectors[2].clone().multiplyScalar(e.z))):n.copy(e);let r=o.atom.clone();r.position.copy(n);let l=o.outline.clone();return l.position.copy(n),[r,l,n]}addAtom(e,t,i,s,o=!0){let n=this.createAtom(t,i,s,o),r=n[0],l=n[1],a=n[2],h=new THREE.Group;h.name="atom"+e,r.name="fill",l.name="outline",h.add(r),h.add(l),this.atoms.add(h),this.atomFills.push(r),this.atomOutlines.push(l),this.atomPos.push(a),this.atomNumbers.push(i)}render(){let e=this.rootElement,t=e.clientWidth,i=e.clientHeight,s=new THREE.Vector3(1,0,0),o=new THREE.Vector3(0,0,0),n=[s,o];for(let e=0;e<n.length;++e){let s=n[e];this.camera.localToWorld(s),s.project(this.camera),s.x=Math.round((s.x+1)*t/2),s.y=Math.round((1-s.y)*i/2)}let r=(new THREE.Vector3).subVectors(o,s).length(),l=8/Math.pow(r,.5);if(void 0!==this.axisLabels)for(let e=0;e<this.axisLabels.length;++e){this.axisLabels[e].scale.set(l,l,1)}super.render()}setup0D(e,t,i){this.createConventionalCell([!1,!1,!1],this.options.structure.showCell),this.createPrimitiveCell([!1,!1,!1],this.options.structure.showCell),this.createAtoms(e,i,!1),this.createLatticeParameters(this.basisVectors,[!1,!1,!1])}setup1D(e,t,i,s,o){let n=o[0],r=new THREE.Vector3;r.setComponent(n,1);let l=this.basisVectors[n].clone(),a=this.getRepetitions(l,15),h=[],c=[];for(let t=1;t<=a;++t){let s=r.clone().multiplyScalar(t);for(let t=0;t<e.length;++t){let o=(new THREE.Vector3).copy(e[t]);o.add(s);let n=i[t];h.push(o),c.push(n)}let o=r.clone().multiplyScalar(-t);for(let t=0;t<e.length;++t){let s=(new THREE.Vector3).copy(e[t]);s.add(o);let n=i[t];h.push(s),c.push(n)}}e.push.apply(e,h),i.push.apply(i,c),this.options.structure.showCell&&(this.createConventionalCell(s),this.createPrimitiveCell(s)),this.createAtoms(e,i,!1),this.createLatticeParameters(this.basisVectors,s),this.setupInitialView1D(s)}getRepetitions(e,t){let i=e.length();return Math.max(Math.floor(t/i)-1,1)}setup2D(e,t,i,s,o){let n=o[0],r=o[1],l=new THREE.Vector3;l.setComponent(n,1);let a=new THREE.Vector3;a.setComponent(r,1);let h=this.basisVectors[n].clone(),c=this.basisVectors[r].clone(),d=0,u=0;this.options.structure.allowRepeat&&(d=this.getRepetitions(h,12),u=this.getRepetitions(c,12));let p=[],E=[];for(let t=0;t<=d;++t)for(let s=0;s<=u;++s)if(0!=t||0!=s){let o=l.clone().multiplyScalar(t),n=a.clone().multiplyScalar(s);for(let t=0;t<e.length;++t){let s=(new THREE.Vector3).copy(e[t]);s.add(o),s.add(n);let r=i[t];p.push(s),E.push(r)}}e.push.apply(e,p),i.push.apply(i,E),this.createConventionalCell(s,this.options.structure.showCell),this.createPrimitiveCell(s,this.options.structure.showCell),this.createAtoms(e,i,!1),this.createLatticeParameters(this.basisVectors,s,o),this.setupInitialView2D(s,o)}setup3D(e,t,i){this.createConventionalCell([!0,!0,!0],this.options.structure.showCell),this.createPrimitiveCell([!0,!0,!0],this.options.structure.showCell),this.createAtoms(e,i,this.options.structure.showCopies),this.createLatticeParameters(this.basisVectors,[!0,!0,!0]),this.setupInitialView3D()}}class n extends s{setupScenes(){this.scenes=[],this.sceneZone=new THREE.Scene,this.scenes.push(this.sceneZone),this.sceneInfo=new THREE.Scene,this.scenes.push(this.sceneInfo)}setupLights(){let e=new THREE.DirectionalLight(16777215,.05);e.position.set(0,0,30),this.sceneZone.add(e);let t=new THREE.AmbientLight(4210752,4.1);this.sceneZone.add(t)}setupVisualization(e){let t=e.vertices,i=e.faces,s=e.basis,o=e.segments,n=e.labels;return this.basis=e.basis,t&&i&&s&&o?(n||console.log("No labels provided for Brillouin zone viewer."),this.createBrillouinZone(t,i,s,o,n),this.setupInitialView(),!0):(console.log("The data given for the Brillouin zone viewer is incomplete."),!1)}handleSettings(e){let t={controls:{rotateSpeed:40,enablePan:!1},view:{fitMargin:.01},brillouinZone:{segments:{color:"#E56400"}}};this.fillOptions(e,t),super.handleSettings(t)}setupInitialView(){let e=new THREE.Vector3(0,1,0),t=new THREE.Vector3(1,0,0),i=new THREE.Vector3(0,0,1),s=(new THREE.Vector3).fromArray(this.basis[0]),o=(new THREE.Quaternion).setFromUnitVectors(e,s.clone().normalize());o.conjugate(),this.info.quaternion.copy(o),this.zone.quaternion.copy(o),this.info.updateMatrixWorld(),this.zone.updateMatrixWorld();let n=new THREE.Vector3,r=this.labelPoints.length;for(let e=0;e<r;++e){let t=this.labelPoints[e];n.add(t.getWorldPosition(new THREE.Vector3))}n.multiplyScalar(1/r),n.y=0;let l=(new THREE.Quaternion).setFromUnitVectors(i,n.clone().normalize());l.conjugate(),this.info.quaternion.premultiply(l),this.zone.quaternion.premultiply(l);let a=new THREE.Quaternion;a.setFromAxisAngle(t,Math.PI/8),this.info.quaternion.premultiply(a),this.zone.quaternion.premultiply(a)}createBrillouinZone(e,t,i,s,o){this.zone=new THREE.Object3D,this.zone.name="zone",this.sceneZone.add(this.zone),this.info=new THREE.Object3D,this.info.name="info",this.sceneInfo.add(this.info);let n=new THREE.Geometry,r=new THREE.MeshLambertMaterial({color:15658734,side:THREE.DoubleSide,transparent:!0,opacity:.8}),l=new THREE.LineBasicMaterial({color:53687091,linewidth:2});for(let t=0;t<e.length;++t){let i=e[t];n.vertices.push((new THREE.Vector3).fromArray(i).multiplyScalar(1e-10))}let a={};for(let i=0;i<t.length;++i){let s=t[i],o=s.length;for(let t=0;t<o;++t){let i=s[t],r=s[(t+1)%o],h=[i,r],c=[r,i];if(!a.hasOwnProperty(h.toString())&&!a.hasOwnProperty(c.toString())){a[h.toString()]=!0,a[c.toString()]=!0;let t=new THREE.Geometry;t.vertices.push((new THREE.Vector3).fromArray(e[i]).multiplyScalar(1e-10),(new THREE.Vector3).fromArray(e[r]).multiplyScalar(1e-10));let s=new THREE.Line(t,l);this.zone.add(s)}if(t<o-2){let e=new THREE.Face3(s[0],s[(t+1)%o],s[(t+2)%o]);n.faces.push(e)}}}n.computeFaceNormals();let h=(e,t)=>{let i=document.createElement("canvas");i.width=256,i.height=256;let s=i.getContext("2d");s.fillStyle="#000000",s.font="90px "+this.options.font.family,s.textAlign="center",s.fillText(t,128,128);let o=new THREE.Texture(i);o.needsUpdate=!0;let n=new THREE.SpriteMaterial({map:o}),r=new THREE.Sprite(n);r.position.copy(e);return r.scale.set(1/11,1/11,1),r};for(let e=0;e<3;++e){let t=.7,s=i[e],o=new THREE.Vector3(0,0,0),n=(new THREE.Vector3).fromArray(s).multiplyScalar(1e-10).multiplyScalar(t),r=new THREE.Geometry;r.vertices.push(o,n);let l=new THREE.LineDashedMaterial({color:0,linewidth:.1,dashSize:.005,gapSize:.005}),a=new THREE.Line(r,l);a.computeLineDistances(),this.info.add(a);let c=.02,d=(new THREE.Vector3).copy(n).multiplyScalar(1+c/n.length()),u="";switch(e){case 0:u="b₁";break;case 1:u="b₂";break;case 2:u="b₃"}u=h(d,u),this.info.add(u);let p=new THREE.CylinderGeometry(0,.003,.012,12),E=new THREE.MeshBasicMaterial({color:0}),m=new THREE.Mesh(p,E);m.position.copy(n),m.lookAt(new THREE.Vector3),m.rotateX(-Math.PI/2),this.info.add(m)}let c=[].concat.apply([],i),d=(new THREE.Matrix3).fromArray(c),u={},p=(e,t)=>{let i=document.createElement("canvas");i.width=256,i.height=256;let s=i.getContext("2d");s.beginPath(),s.arc(128,128,256/15,0,2*Math.PI),s.fillStyle=this.options.brillouinZone.segments.color,s.fill(),s.fillStyle="#000000",s.font="100px "+this.options.font.family,s.textAlign="center",s.fillText(t,i.width/2,80);let o=new THREE.Texture(i);o.needsUpdate=!0;let n=new THREE.SpriteMaterial({map:o}),r=new THREE.Sprite(n);r.position.copy(e);return r.scale.set(1/15,1/15,1),r},E=new THREE.LineBasicMaterial({color:this.options.brillouinZone.segments.color,linewidth:3}),m=new THREE.Geometry;this.labelPoints=[];for(let e=0;e<s.length;++e){let t=s[e],i=t.length,n=[0,i-1];for(let s of n){let n=(new THREE.Vector3).fromArray(t[s]).multiplyScalar(1e-10);if(n.applyMatrix3(d),m.vertices.push(n),o&&(0===s||s===i-1)){let t="";0===s?t=o[e][0]:s===i-1&&(t=o[e][1]);let r=!1;for(let e=0;e<this.labelPoints.length;++e){let t=this.labelPoints[e].position;(new THREE.Vector3).copy(n).addScaledVector(t,-1).length()<1e-5&&(r=!0)}if(!r){u[t]=!0;let e=p(n,t);this.info.add(e),this.labelPoints.push(e)}}}}let w=new THREE.Line(m,E);this.info.add(w);let T=new THREE.Mesh(n,r);this.zone.add(T),this.cornerPoints=new THREE.Points(n),this.cornerPoints.visible=!0}}}]);